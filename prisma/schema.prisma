// =============================================================
// DYNAMIC RBAC PAYROLL SAAS - DEEL-INSPIRED ARCHITECTURE
// =============================================================
// This schema eliminates rigid role-based models and implements
// a flexible, permission-based system where everything revolves 
// around Users with dynamic role assignments.
// =============================================================

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================
// CORE: TENANT
// =============================================================
model Tenant {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  logoUrl          String?
  
  // Branding
  primaryColor     String?  @default("#3b82f6")
  accentColor      String?  @default("#10b981")
  backgroundColor  String?  @default("#f8fafc")
  sidebarBgColor   String?  @default("#ffffff")
  sidebarTextColor String?  @default("#111827")
  headerBgColor    String?  @default("#ffffff")
  headerTextColor  String?  @default("#111827")
  
  // Billing & Status
  plan             String   @default("trial") // trial, starter, professional, enterprise
  billingEmail     String?
  subscriptionStatus String @default("active") // active, suspended, cancelled
  trialEndsAt      DateTime?
  
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  users                    User[]
  roles                    Role[]
  organizations            Organization[]
  contracts                Contract[]
  invoices                 Invoice[]
  timesheets               Timesheet[]
  payments                 Payment[]
  banks                    Bank[]
  documentTypes            DocumentType[]
  leads                    Lead[]
  tasks                    Task[]
  onboardingTemplates      OnboardingTemplate[]
  payslips                 Payslip[]
  auditLogs                AuditLog[]
  webhookSubscriptions     WebhookSubscription[]

  @@map("tenants")
}

// =============================================================
// CORE: USER (Center of Everything)
// =============================================================
model User {
  id                 String   @id @default(cuid())
  tenantId           String
  email              String
  passwordHash       String
  name               String?
  avatar             String?
  phone              String?
  timezone           String?  @default("UTC")
  locale             String?  @default("en")
  
  // Status & Security
  isActive           Boolean  @default(true)
  mustChangePassword Boolean  @default(true)
  emailVerified      Boolean  @default(false)
  lastLoginAt        DateTime?
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  tenant                   Tenant                     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles                UserRole[]                 // Many-to-many with roles
  userOrganizations        UserOrganization[]         // Link to organizations
  profile                  UserProfile?               // Extended profile
  
  // Business Relations (User-centric)
  contractsCreated         Contract[]                 @relation("ContractCreator")
  contractsAssigned        Contract[]                 @relation("ContractAssignee")
  invoicesCreated          Invoice[]                  @relation("InvoiceCreator")
  timesheetsSubmitted      Timesheet[]                @relation("TimesheetUser")
  paymentsReceived         Payment[]                  @relation("PaymentRecipient")
  payslipsReceived         Payslip[]
  
  // Auth & Security
  accounts                 Account[]
  sessions                 Session[]
  passwordResetTokens      PasswordResetToken[]
  
  // Activity
  tasksAssignedTo          Task[]                     @relation("TasksAssignedTo")
  tasksCreated             Task[]                     @relation("TasksCreatedBy")
  auditLogs                AuditLog[]
  notificationPreferences  NotificationPreference[]
  onboardingResponses      OnboardingResponse[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([isActive])
  @@map("users")
}

// =============================================================
// USER PROFILE (Flexible Metadata)
// =============================================================
model UserProfile {
  id                String    @id @default(cuid())
  userId            String    @unique
  
  // Personal Information
  firstName         String?
  lastName          String?
  dateOfBirth       DateTime?
  nationality       String?
  
  // Contact Details
  alternatePhone    String?
  alternateEmail    String?
  skypeId           String?
  linkedinUrl       String?
  
  // Address
  address1          String?
  address2          String?
  city              String?
  state             String?
  postCode          String?
  countryId         String?
  
  // Professional Details
  jobTitle          String?
  department        String?
  employeeId        String?
  startDate         DateTime?
  
  // Banking (for payments)
  bankName          String?
  accountNumber     String?
  swiftCode         String?
  iban              String?
  taxId             String?
  
  // Metadata (JSON for flexibility)
  metadata          Json?     // Can store any additional custom fields
  notes             String?   @db.Text
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  country           Country?  @relation(fields: [countryId], references: [id])

  @@map("user_profiles")
}

// =============================================================
// RBAC: ROLE, PERMISSION, USER-ROLE
// =============================================================
model Role {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  homePath    String   @default("/home")
  isSystem    Boolean  @default(false) // System roles cannot be deleted
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("roles")
}

model Permission {
  id          String   @id @default(cuid())
  key         String   @unique
  category    String   // e.g., "contracts", "invoices", "users"
  description String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]

  @@index([category])
  @@map("permissions")
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// Many-to-many: User can have multiple roles
model UserRole {
  userId       String
  roleId       String
  isPrimary    Boolean  @default(false) // One role can be primary for UI purposes
  assignedAt   DateTime @default(now())
  assignedBy   String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

// =============================================================
// ORGANIZATION (Replaces Agency, PayrollPartner, Company)
// =============================================================
model Organization {
  id              String   @id @default(cuid())
  tenantId        String
  type            String   // "client", "agency", "payroll_partner", "internal"
  name            String
  legalName       String?
  registrationNumber String?
  vatNumber       String?
  
  // Contact
  contactPerson   String?
  contactEmail    String?
  contactPhone    String?
  website         String?
  
  // Address
  address1        String?
  address2        String?
  city            String?
  state           String?
  postCode        String?
  countryId       String?
  
  // Financial
  defaultCurrency String?  @default("USD")
  paymentTerms    Int?     // Days
  
  // Status
  status          String   @default("active") // active, inactive, suspended
  metadata        Json?    // Flexible additional data
  notes           String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant               Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  country              Country?              @relation(fields: [countryId], references: [id])
  userOrganizations    UserOrganization[]
  contractsAsClient    Contract[]            @relation("ClientOrganization")
  contractsAsProvider  Contract[]            @relation("ProviderOrganization")

  @@index([tenantId])
  @@index([type])
  @@index([status])
  @@map("organizations")
}

// Link users to organizations with specific context
model UserOrganization {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  relationship   String   // "employee", "contractor", "client_admin", "manager", etc.
  isPrimary      Boolean  @default(false)
  startDate      DateTime @default(now())
  endDate        DateTime?
  metadata       Json?    // Flexible data like rate, title, etc.
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId, relationship])
  @@index([userId])
  @@index([organizationId])
  @@map("user_organizations")
}

// =============================================================
// BUSINESS: CONTRACT
// =============================================================
model Contract {
  id                   String    @id @default(cuid())
  tenantId             String
  contractNumber       String?   @unique
  
  // Parties (User-centric)
  createdById          String    // User who created the contract
  assignedToId         String    // Primary user (contractor/worker)
  clientOrgId          String?   // Client organization
  providerOrgId        String?   // Agency or service provider
  
  // Contract Details
  title                String
  description          String?   @db.Text
  type                 String    @default("service") // service, employment, consulting
  status               String    @default("draft") // draft, pending, active, completed, terminated, cancelled
  
  // Financial
  rate                 Decimal?  @db.Decimal(12, 2)
  rateType             String?   // hourly, daily, weekly, monthly, fixed
  currency             String    @default("USD")
  paymentSchedule      String?   // weekly, biweekly, monthly
  
  // Dates
  startDate            DateTime?
  endDate              DateTime?
  signedDate           DateTime?
  terminatedDate       DateTime?
  
  // Documents
  signedContractUrl    String?
  terminationReason    String?   @db.Text
  
  // Additional
  notes                String?   @db.Text
  metadata             Json?
  
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  tenant            Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator           User          @relation("ContractCreator", fields: [createdById], references: [id])
  assignee          User          @relation("ContractAssignee", fields: [assignedToId], references: [id])
  clientOrg         Organization? @relation("ClientOrganization", fields: [clientOrgId], references: [id])
  providerOrg       Organization? @relation("ProviderOrganization", fields: [providerOrgId], references: [id])
  
  invoices          Invoice[]
  timesheets        Timesheet[]
  payments          Payment[]
  payslips          Payslip[]
  documents         ContractDocument[]
  statusHistory     ContractStatusHistory[]

  @@index([tenantId])
  @@index([assignedToId])
  @@index([status])
  @@index([createdById])
  @@map("contracts")
}

model ContractDocument {
  id           String   @id @default(cuid())
  contractId   String
  name         String
  fileUrl      String
  fileSize     Int
  mimeType     String
  type         String   // "contract", "amendment", "termination", "supporting"
  version      Int      @default(1)
  uploadedById String
  uploadedAt   DateTime @default(now())

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@map("contract_documents")
}

model ContractStatusHistory {
  id         String   @id @default(cuid())
  contractId String
  fromStatus String?
  toStatus   String
  changedBy  String
  reason     String?  @db.Text
  metadata   Json?
  changedAt  DateTime @default(now())

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@map("contract_status_history")
}

// =============================================================
// BUSINESS: INVOICE
// =============================================================
model Invoice {
  id              String    @id @default(cuid())
  tenantId        String
  contractId      String?
  invoiceNumber   String    @unique
  
  // Created by user (not rigid role)
  createdById     String
  
  // Status
  status          String    @default("draft") // draft, sent, paid, overdue, cancelled, void
  
  // Financial
  subtotal        Decimal   @db.Decimal(12, 2)
  taxRate         Decimal   @default(0) @db.Decimal(5, 2)
  taxAmount       Decimal   @default(0) @db.Decimal(12, 2)
  discount        Decimal   @default(0) @db.Decimal(12, 2)
  totalAmount     Decimal   @db.Decimal(12, 2)
  currency        String    @default("USD")
  
  // Dates
  issueDate       DateTime  @default(now())
  dueDate         DateTime
  paidDate        DateTime?
  sentDate        DateTime?
  
  // Details
  description     String?   @db.Text
  notes           String?   @db.Text
  paymentInstructions String? @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant      Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  creator     User               @relation("InvoiceCreator", fields: [createdById], references: [id])
  contract    Contract?          @relation(fields: [contractId], references: [id], onDelete: SetNull)
  lineItems   InvoiceLineItem[]
  payments    Payment[]

  @@index([tenantId])
  @@index([contractId])
  @@index([status])
  @@index([createdById])
  @@map("invoices")
}

model InvoiceLineItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(12, 2)
  amount      Decimal @db.Decimal(12, 2)
  taxRate     Decimal @default(0) @db.Decimal(5, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_line_items")
}

// =============================================================
// BUSINESS: TIMESHEET
// =============================================================
model Timesheet {
  id              String    @id @default(cuid())
  tenantId        String
  userId          String    // User submitting timesheet
  contractId      String?
  
  // Period
  periodStart     DateTime
  periodEnd       DateTime
  
  // Hours & Status
  totalHours      Decimal   @db.Decimal(8, 2)
  regularHours    Decimal   @default(0) @db.Decimal(8, 2)
  overtimeHours   Decimal   @default(0) @db.Decimal(8, 2)
  
  status          String    @default("draft") // draft, submitted, approved, rejected, paid
  
  // Approval
  submittedAt     DateTime?
  approvedAt      DateTime?
  approvedBy      String?
  rejectedAt      DateTime?
  rejectedBy      String?
  rejectionReason String?   @db.Text
  
  // Financial
  hourlyRate      Decimal?  @db.Decimal(12, 2)
  totalAmount     Decimal?  @db.Decimal(12, 2)
  
  notes           String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User      @relation("TimesheetUser", fields: [userId], references: [id])
  contract Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)
  entries  TimesheetEntry[]

  @@index([tenantId])
  @@index([userId])
  @@index([contractId])
  @@index([status])
  @@map("timesheets")
}

model TimesheetEntry {
  id          String   @id @default(cuid())
  timesheetId String
  date        DateTime
  hours       Decimal  @db.Decimal(8, 2)
  description String?  @db.Text
  projectCode String?
  taskType    String?  // regular, overtime, break, etc.
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  timesheet Timesheet @relation(fields: [timesheetId], references: [id], onDelete: Cascade)

  @@index([timesheetId])
  @@index([date])
  @@map("timesheet_entries")
}

// =============================================================
// BUSINESS: PAYMENT
// =============================================================
model Payment {
  id              String    @id @default(cuid())
  tenantId        String
  recipientId     String    // User receiving payment
  invoiceId       String?
  contractId      String?
  
  // Payment Details
  amount          Decimal   @db.Decimal(12, 2)
  currency        String    @default("USD")
  paymentMethod   String    // bank_transfer, paypal, stripe, wise, etc.
  status          String    @default("pending") // pending, processing, completed, failed, cancelled
  
  // Reference
  referenceNumber String?
  transactionId   String?
  
  // Dates
  scheduledDate   DateTime
  processedDate   DateTime?
  completedDate   DateTime?
  
  // Details
  description     String?   @db.Text
  notes           String?   @db.Text
  failureReason   String?   @db.Text
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  recipient User      @relation("PaymentRecipient", fields: [recipientId], references: [id])
  invoice   Invoice?  @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  contract  Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([recipientId])
  @@index([invoiceId])
  @@index([status])
  @@map("payments")
}

// =============================================================
// BUSINESS: PAYSLIP
// =============================================================
model Payslip {
  id              String    @id @default(cuid())
  tenantId        String
  userId          String    // User receiving payslip
  contractId      String?
  
  // Period
  periodMonth     Int
  periodYear      Int
  
  // Financial
  grossPay        Decimal   @db.Decimal(12, 2)
  netPay          Decimal   @db.Decimal(12, 2)
  deductions      Decimal   @default(0) @db.Decimal(12, 2)
  tax             Decimal   @default(0) @db.Decimal(12, 2)
  bonus           Decimal   @default(0) @db.Decimal(12, 2)
  currency        String    @default("USD")
  
  // Status
  status          String    @default("draft") // draft, generated, sent, viewed
  
  // Dates
  generatedDate   DateTime  @default(now())
  sentDate        DateTime?
  viewedDate      DateTime?
  paidDate        DateTime?
  
  // File
  fileUrl         String?
  
  notes           String?   @db.Text
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id])
  contract Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  @@unique([tenantId, userId, periodMonth, periodYear])
  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@map("payslips")
}

// =============================================================
// BUSINESS: BANK
// =============================================================
model Bank {
  id            String   @id @default(cuid())
  tenantId      String
  name          String
  accountName   String?
  accountNumber String?
  swiftCode     String?
  iban          String?
  routingNumber String?
  bankCode      String?
  branchCode    String?
  address       String?  @db.Text
  country       String?
  currency      String?  @default("USD")
  status        String   @default("active")
  isDefault     Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("banks")
}

// =============================================================
// REFERENCE: COUNTRY & CURRENCY
// =============================================================
model Country {
  id        String   @id @default(cuid())
  code      String   @unique // ISO 3166-1 alpha-2
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organizations Organization[]
  userProfiles  UserProfile[]

  @@map("countries")
}

// =============================================================
// DOCUMENT TYPES
// =============================================================
model DocumentType {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?
  category    String?  // "contract", "identity", "tax", "compliance"
  isRequired  Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@map("document_types")
}

// =============================================================
// LEADS
// =============================================================
model Lead {
  id           String    @id @default(cuid())
  tenantId     String
  name         String
  company      String?
  email        String?
  phone        String?
  status       String    @default("new") // new, contacted, qualified, negotiating, won, lost
  source       String?   // website, referral, linkedin, etc.
  estimatedValue Decimal? @db.Decimal(12, 2)
  currency     String?   @default("USD")
  lastContact  DateTime?
  notes        String?   @db.Text
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([status])
  @@map("leads")
}

// =============================================================
// TASKS
// =============================================================
model Task {
  id          String    @id @default(cuid())
  tenantId    String
  title       String
  description String?   @db.Text
  assignedTo  String
  createdBy   String
  priority    String    @default("medium") // low, medium, high, urgent
  status      String    @default("pending") // pending, in_progress, completed, cancelled
  dueDate     DateTime?
  completedAt DateTime?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant       Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignedUser User   @relation("TasksAssignedTo", fields: [assignedTo], references: [id])
  creator      User   @relation("TasksCreatedBy", fields: [createdBy], references: [id])

  @@index([tenantId])
  @@index([assignedTo])
  @@index([status])
  @@map("tasks")
}

// =============================================================
// ONBOARDING
// =============================================================
model OnboardingTemplate {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  description String?  @db.Text
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant    Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  questions OnboardingQuestion[]

  @@map("onboarding_templates")
}

model OnboardingQuestion {
  id         String   @id @default(cuid())
  templateId String
  question   String   @db.Text
  type       String   // text, file, select, multiselect, date
  options    Json?    // For select/multiselect questions
  isRequired Boolean  @default(true)
  order      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  template  OnboardingTemplate   @relation(fields: [templateId], references: [id], onDelete: Cascade)
  responses OnboardingResponse[]

  @@index([templateId])
  @@map("onboarding_questions")
}

model OnboardingResponse {
  id          String    @id @default(cuid())
  userId      String
  questionId  String
  answer      String?   @db.Text
  fileUrl     String?
  status      String    @default("pending") // pending, approved, rejected
  reviewNotes String?   @db.Text
  submittedAt DateTime?
  reviewedAt  DateTime?
  reviewedBy  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user     User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  question OnboardingQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([userId])
  @@map("onboarding_responses")
}

// =============================================================
// AUTH MODELS
// =============================================================
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_reset_tokens")
}

// =============================================================
// SUPER ADMIN
// =============================================================
model SuperAdmin {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("super_admins")
}

// =============================================================
// AUDIT LOG
// =============================================================
model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String?
  userId      String?
  action      String
  entityType  String
  entityId    String?
  description String
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("audit_logs")
}

// =============================================================
// WEBHOOKS
// =============================================================
model WebhookSubscription {
  id        String   @id @default(cuid())
  tenantId  String
  url       String
  events    String[]
  secret    String
  isActive  Boolean  @default(true)
  headers   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  deliveryLogs WebhookDelivery[]

  @@map("webhook_subscriptions")
}

model WebhookDelivery {
  id             String    @id @default(cuid())
  subscriptionId String
  event          String
  payload        Json
  statusCode     Int?
  response       String?
  success        Boolean
  attempt        Int       @default(1)
  deliveredAt    DateTime?
  createdAt      DateTime  @default(now())

  subscription WebhookSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([event])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

// =============================================================
// NOTIFICATION PREFERENCES
// =============================================================
model NotificationPreference {
  id        String   @id @default(cuid())
  userId    String
  channel   String   // email, sms, in_app, push
  event     String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channel, event])
  @@map("notification_preferences")
}

// =============================================================
// EMAIL & SMS LOGS
// =============================================================
model EmailLog {
  id        String    @id @default(cuid())
  tenantId  String?
  to        String
  from      String
  subject   String
  template  String?
  status    String    // queued, sent, failed, bounced
  messageId String?
  error     String?
  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}

model SMSLog {
  id        String    @id @default(cuid())
  tenantId  String?
  to        String
  from      String
  message   String
  template  String?
  status    String    // queued, sent, failed, delivered
  messageId String?
  error     String?
  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
  @@map("sms_logs")
}

// =============================================================
// SYSTEM CONFIGURATION
// =============================================================
model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  category  String
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("system_configs")
}
