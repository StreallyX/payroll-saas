// ====
// DEEL-LIKE PLATFORM - RBAC v4 REFACTORED SCHEMA
// ====
// Architecture RBAC professionnelle et multi-tenant
// - Tout le monde est un User avec un rÃ´le (RBAC pur)
// - Pas de modÃ¨les sÃ©parÃ©s Contractor/Agency/PayrollPartner
// - Tables de jonction pour relations many-to-many (ContractParticipant)
// - Champs optionnels partout pour flexibilitÃ© maximale
// - SystÃ¨me de permissions granulaires
// - Architecture inspirÃ©e de Deel et Rippling
// ====

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ====
// CORE RBAC MODELS
// ====

/// Table Role - RÃ´les dynamiques avec hiÃ©rarchie
/// Exemples: SUPER_ADMIN, ADMIN, CONTRACTOR, CLIENT, AGENCY_OWNER, PAYROLL_PARTNER, ACCOUNTANT
model Role {
  id          String   @id @default(cuid())
  tenantId    String
  name        String
  displayName String
  description String?  @db.Text

  level       Int      @default(0)

  homePath    String   @default("/dashboard")
  color       String?  @default("#3b82f6")
  icon        String?  @default("user")

  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // ðŸ”¥ NOUVEAU : l'utilisateur qui a crÃ©Ã© ce rÃ´le (pour OWN scopes)
  createdBy   String?
  creator     User?    @relation("RoleCreatedBy", fields: [createdBy], references: [id])

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users User[] @relation("RoleUsers")
  rolePermissions RolePermission[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isActive])
  @@index([level])
  @@index([createdBy])     // ðŸ”¥ important pour role.own lookups

  @@map("roles")
}


/// Table Permission - Permissions granulaires avec resource + action
model Permission {
  id          String   @id @default(cuid())
  
  // Structure resource.action
  resource    String   // Ex: "contract", "invoice", "user", "payment"
  action      String   // Ex: "create", "read", "update", "delete", "approve", "export"
  
  // ClÃ© unique combinÃ©e (ex: "contract.create")
  key         String   @unique
  
  // MÃ©tadonnÃ©es
  displayName String   // Ex: "CrÃ©er un contrat"
  description String?  @db.Text
  category    String?  // Ex: "Gestion", "Finance", "Administration"
  
  // Scope pour permissions contextuelles
  scope       String   @default("global") // "global", "own", "team", "tenant"
  
  // Status
  isActive    Boolean  @default(true)
  isSystem    Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  rolePermissions RolePermission[]

  @@unique([resource, action, scope])
  @@index([resource])
  @@index([action])
  @@index([scope])
  @@index([isActive])
  @@map("permissions")
}

/// Table RolePermission - Relation many-to-many entre Role et Permission
model RolePermission {
  roleId       String
  permissionId String
  
  // Conditions additionnelles (optionnel)
  conditions   Json? // Ex: { "maxAmount": 10000, "requiresApproval": true }
  
  createdAt    DateTime @default(now())

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// ====
// TENANT MODEL
// ====
model Tenant {
  id      String  @id @default(cuid())
  name    String
  logoUrl String?
  
  // Branding
  primaryColor        String?  @default("#3b82f6")
  accentColor         String?  @default("#10b981")
  backgroundColor     String?  @default("#f8fafc")
  sidebarBgColor      String?  @default("#ffff")
  sidebarTextColor    String?  @default("#111827")
  headerBgColor       String?  @default("#ffff")
  headerTextColor     String?  @default("#111827")
  customFont          String?  @default("Inter")
  
  // Domain & Email
  customEmailDomain     String?
  emailDomainVerified   Boolean  @default(false)
  subdomain             String?  @unique
  customDomain          String?  @unique
  customDomainVerified  Boolean  @default(false)
  sslCertificateStatus  String?  // pending, active, expired, failed
  sslCertificateExpiry  DateTime?
  
  // Subscription
  subscriptionPlan      String   @default("free") // free, starter, professional, enterprise
  subscriptionStatus    String   @default("active") // active, trial, suspended, cancelled
  subscriptionStartDate DateTime @default(now())
  subscriptionEndDate   DateTime?
  
  // Usage & Limits
  currentStorageUsed    BigInt   @default(0)
  usageMetrics          Json?    // { apiCalls: 0, emailsSent: 0, invoicesCreated: 0 }
  
  // Localization
  timezone        String @default("UTC")
  defaultLanguage String @default("en")
  defaultCurrency String @default("USD")
  dateFormat      String @default("MM/DD/YYYY")
  timeFormat      String @default("12h")
  
  // White-label
  loginPageConfig      Json?
  navigationConfig     Json?
  termsOfService       String? @db.Text
  termsVersion         String? @default("1.0")
  privacyPolicy        String? @db.Text
  privacyPolicyVersion String? @default("1.0")
  
  // Onboarding
  onboardingCompleted Boolean @default(false)
  onboardingStep      Int     @default(1)
  onboardingData      Json?
  
  // Status
  isActive Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  roles                    Role[]
  users                    User[]
  companies                Company[]
  contracts                Contract[]
  invoices                 Invoice[]
  banks                    Bank[]
  documentTypes            DocumentType[]
  leads                    Lead[]
  tasks                    Task[]
  onboardingTemplates      OnboardingTemplate[]
  payslips                 Payslip[]
  auditLogs                AuditLog[]
  webhookSubscriptions     WebhookSubscription[]
  payments                 Payment[]
  paymentMethods           PaymentMethod[]
  expenses                 Expense[]
  timesheets               Timesheet[]
  approvalWorkflows        ApprovalWorkflow[]
  documents                Document[]
  tags                     Tag[]
  tagAssignments           TagAssignment[]
  customFields             CustomField[]
  customFieldValues        CustomFieldValue[]
  userActivities           UserActivity[]
  apiKeys                  ApiKey[]
  remittances              Remittance[]
  referrals                Referral[]
  featureFlags             TenantFeatureFlag[]
  quotas                   TenantQuota?
  emailTemplates           EmailTemplate[]
  pdfTemplates             PDFTemplate[]
  securitySettings         TenantSecuritySettings?
  dataExports              DataExport[]
  onboardingResponses      OnboardingResponse[]

  @@map("tenants")
}

model User {
  id                 String   @id @default(cuid())
  tenantId           String
  email              String
  passwordHash       String
  mustChangePassword Boolean  @default(true)
  
  roleId             String

  name               String?
  profilePictureUrl  String?
  phone              String?
  alternatePhone     String?
  dateOfBirth        DateTime?
  timezone           String?  @default("UTC")
  language           String?  @default("en")

  // ðŸ”¥ Ownership (comme Deel)
  createdBy          String?   // userId
  createdUsers       User[]     @relation("UserCreatedUsers")
  createdByUser      User?      @relation("UserCreatedUsers", fields: [createdBy], references: [id])

  profileData        Json?

  officeBuilding     String?
  address1           String?
  address2           String?
  city               String?
  countryId          String?
  state              String?
  postCode           String?

  companyName        String?
  vatNumber          String?
  website            String?

  invoicingContactName      String?
  invoicingContactPhone     String?
  invoicingContactEmail     String?
  alternateInvoicingEmail   String?

  onboardingTemplateId      String?
  onboardingStatus          String?  @default("pending")

  emailVerified      Boolean   @default(false)
  lastLoginAt        DateTime?
  twoFactorEnabled   Boolean   @default(false)
  twoFactorSecret    String?
  lastActivityAt     DateTime?

  preferences        Json?

  isActive           Boolean  @default(true)
  status             String   @default("active")

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role Role @relation("RoleUsers", fields: [roleId], references: [id])
  country            Country?            @relation(fields: [countryId], references: [id])
  onboardingTemplate OnboardingTemplate? @relation(fields: [onboardingTemplateId], references: [id])
  rolesCreated Role[] @relation("RoleCreatedBy")

  contractParticipants ContractParticipant[]
  companyUsers         CompanyUser[]

  accounts              Account[]
  sessions              Session[]
  passwordResetTokens   PasswordResetToken[]

  auditLogs            AuditLog[]
  activities           UserActivity[]

  tasksAssignedTo      Task[]           @relation("TasksAssignedTo")
  tasksAssignedBy      Task[]           @relation("TasksAssignedBy")

  notificationPreferences NotificationPreference[]

  apiKeysCreated       ApiKey[]         @relation("ApiKeyCreatedBy")
  apiKeysRevoked       ApiKey[]         @relation("ApiKeyRevokedBy")

  customFieldValues    CustomFieldValue[]

  payslips             Payslip[]
  onboardingResponses  OnboardingResponse[]
  expenses             Expense[]
  timesheets           Timesheet[]
  remittances          Remittance[]
  referralsMade        Referral[]       @relation("ReferralsMade")
  referralsReceived    Referral[]       @relation("ReferralsReceived")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([roleId])
  @@index([isActive])
  @@index([lastLoginAt])
  @@index([createdBy])
  @@index([status])

  @@map("users")
}


// ====
// COMPANY (Client)
// ====
model Company {
  id           String  @id @default(cuid())
  tenantId     String
  name         String
  
  // Ownership
  createdBy    String? // userId qui a crÃ©Ã©
  
  // Contacts
  contactPerson String?
  contactEmail  String?
  contactPhone  String?
  
  // Address
  officeBuilding String?
  address1       String?
  address2       String?
  city           String?
  countryId      String?
  state          String?
  postCode       String?
  
  // Invoicing
  invoicingContactName     String?
  invoicingContactPhone    String?
  invoicingContactEmail    String?
  alternateInvoicingEmail  String?
  vatNumber                String?
  website                  String?
  
  // Status
  status    String @default("active")
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  country      Country?      @relation(fields: [countryId], references: [id])
  contracts    Contract[]
  companyUsers CompanyUser[]

  @@index([tenantId])
  @@index([createdBy])
  @@map("companies")
}

// ðŸ”¥ NEW: Table de jonction pour lier Users et Companies (pour les clients internes)
model CompanyUser {
  id        String   @id @default(cuid())
  companyId String
  userId    String
  role      String?  @default("member") // owner, admin, member, billing_contact
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@index([companyId])
  @@index([userId])
  @@map("company_users")
}

// ====
// CONTRACT (Architecture flexible multi-parties)
// ====
model Contract {
  id       String @id @default(cuid())
  tenantId String

  companyId String?

  createdBy  String?
  assignedTo String?

  status      String  @default("draft")
  title       String?
  description String? @db.Text
  notes       String? @db.Text

  workflowStatus     String    @default("draft")
  terminationReason  String?   @db.Text
  terminatedAt       DateTime?
  terminatedBy       String?

  rate           Decimal? @db.Decimal(10, 2)
  rateType       String?
  currencyId     String?
  rateCycle      String?
  margin         Decimal? @db.Decimal(10, 2)
  marginType     String?
  marginPaidBy   String?
  salaryType     String?
  bankId         String?
  invoiceDueDays Int?

  contractReference  String?   @unique
  contractCountryId  String?
  contractVatRate    Decimal?  @db.Decimal(5, 2)

  startDate  DateTime?
  endDate    DateTime?
  signedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant           Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  company          Company? @relation(fields: [companyId], references: [id])
  currency         Currency? @relation(fields: [currencyId], references: [id])
  bank             Bank?     @relation(fields: [bankId], references: [id])
  contractCountry  Country?  @relation(fields: [contractCountryId], references: [id])

  participants     ContractParticipant[]

  invoices         Invoice[]
  payslips         Payslip[]
  statusHistory    ContractStatusHistory[]
  notifications    ContractNotification[]
  expenses         Expense[]
  timesheets       Timesheet[]
  remittances      Remittance[]

  @@index([tenantId])
  @@index([companyId])
  @@index([createdBy])
  @@index([assignedTo])
  @@index([status])
  @@index([workflowStatus])
  @@map("contracts")
}

// ðŸ”¥ NEW: Table de jonction pour gÃ©rer les multiples parties d'un contrat
// Architecture inspirÃ©e de Deel pour gÃ©rer contractor, agency, payroll partner, client, etc.
model ContractParticipant {
  id         String   @id @default(cuid())
  contractId String
  userId     String
  
  // ðŸ”¥ Type de participant dans le contrat
  role       String   // "contractor", "agency", "payroll_partner", "client_admin", "approver"
  
  // Signature
  requiresSignature Boolean   @default(false)
  signedAt          DateTime?
  signatureUrl      String?   // URL du document signÃ©
  
  // Status
  isActive   Boolean  @default(true)
  isPrimary  Boolean  @default(false) // Pour identifier le participant principal (ex: le contractor)
  
  // Dates
  joinedAt   DateTime @default(now())
  leftAt     DateTime?
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([contractId, userId, role])
  @@index([contractId])
  @@index([userId])
  @@index([role])
  @@map("contract_participants")
}

model ContractStatusHistory {
  id         String   @id @default(cuid())
  contractId String
  fromStatus String?
  toStatus   String
  changedBy  String   // userId
  changedAt  DateTime @default(now())
  reason     String?  @db.Text
  metadata   Json?

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([changedBy])
  @@map("contract_status_history")
}

model ContractNotification {
  id          String    @id @default(cuid())
  contractId  String
  recipientId String    // userId
  type        String    // "signature_request", "renewal_reminder", "termination_notice", "status_change"
  title       String
  message     String    @db.Text
  sentAt      DateTime  @default(now())
  readAt      DateTime?

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([recipientId])
  @@map("contract_notifications")
}

// ====
// INVOICE (Avec ownership)
// ====
model Invoice {
  id            String   @id @default(cuid())
  tenantId      String
  contractId    String?  // ðŸ”¥ Optionnel - une facture peut ne pas Ãªtre liÃ©e Ã  un contrat
  invoiceNumber String?  @unique
  
  // Ownership
  createdBy     String?  // userId qui a crÃ©Ã©
  
  // Status
  status        String   @default("draft") // draft, sent, paid, overdue, cancelled
  
  // Financial
  amount        Decimal  @db.Decimal(10, 2)
  currency      String   @default("USD")
  taxAmount     Decimal  @default(0) @db.Decimal(10, 2)
  totalAmount   Decimal  @default(0) @db.Decimal(10, 2)
  
  // Dates
  issueDate     DateTime @default(now())
  dueDate       DateTime @default(now())
  paidDate      DateTime?
  sentDate      DateTime?
  
  // Details
  description   String?  @db.Text
  notes         String?  @db.Text
  
  // Legacy
  invoiceRef    String?
  paidAt        DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  tenant      Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract    Contract?           @relation(fields: [contractId], references: [id])
  lineItems   InvoiceLineItem[]
  payments    Payment[]
  timesheets  Timesheet[]

  @@index([tenantId])
  @@index([contractId])
  @@index([createdBy])
  @@index([status])
  @@map("invoices")
}

model InvoiceLineItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(10, 2)
  amount      Decimal @db.Decimal(10, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_line_items")
}

// ====
// EXPENSE MANAGEMENT (Avec ownership)
// ====
model Expense {
  id         String   @id @default(cuid())
  tenantId   String
  
  // ðŸ”¥ Ownership - qui a soumis la dÃ©pense (un User)
  submittedBy String  // userId
  
  // ðŸ”¥ Context - contrat liÃ© (optionnel)
  contractId  String?
  
  // Details
  title         String
  description   String?  @db.Text
  amount        Decimal  @db.Decimal(10, 2)
  currency      String
  category      String   // travel, meals, equipment, software, etc.
  
  // ðŸ”¥ Receipt (optionnel)
  receiptUrl      String?
  receiptFileName String?
  
  // Dates
  expenseDate DateTime
  submittedAt DateTime @default(now())
  
  // ðŸ”¥ Approval (optionnel)
  status             String    @default("draft") // draft, submitted, approved, rejected, paid
  approvalWorkflowId String?
  approvedBy         String?   // userId (optionnel)
  approvedAt         DateTime?
  rejectionReason    String?   @db.Text
  paidAt             DateTime?
  
  // Additional
  notes    String? @db.Text
  metadata Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant           Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  submitter        User               @relation(fields: [submittedBy], references: [id])
  contract         Contract?          @relation(fields: [contractId], references: [id])
  approvalWorkflow ApprovalWorkflow?  @relation(fields: [approvalWorkflowId], references: [id])
  payments         Payment[]

  @@index([tenantId])
  @@index([submittedBy])
  @@index([contractId])
  @@index([status])
  @@map("expenses")
}

// ====
// TIME TRACKING (Avec ownership)
// ====
model Timesheet {
  id         String   @id @default(cuid())
  tenantId   String
  
  submittedBy String
  contractId  String?

  // PERIOD
  startDate    DateTime
  endDate      DateTime
  
  // STATUS
  status             String    @default("draft")
  approvalWorkflowId String?
  approvalWorkflow   ApprovalWorkflow? @relation("WorkflowTimesheets", fields: [approvalWorkflowId], references: [id])

  approvedBy        String?
  approvedAt        DateTime?
  rejectionReason   String?   @db.Text

  // TOTALS
  totalHours   Decimal  @db.Decimal(10, 2)
  totalAmount  Decimal? @db.Decimal(10, 2)

  // FILES + NOTES
  notes            String?   @db.Text
  timesheetFileUrl String?
  expenseFileUrl   String?

  // INVOICE
  invoiceId   String?
  submittedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  submitter  User      @relation(fields: [submittedBy], references: [id])
  contract   Contract? @relation(fields: [contractId], references: [id])
  entries    TimesheetEntry[]
  invoice    Invoice?  @relation(fields: [invoiceId], references: [id])

  @@index([tenantId])
  @@index([submittedBy])
  @@index([contractId])
  @@index([status])
  @@map("timesheets")
}


model TimesheetEntry {
  id          String   @id @default(cuid())
  timesheetId String
  date        DateTime
  hours       Decimal  @db.Decimal(5, 2)
  description String?  @db.Text
  projectName String?
  taskName    String?
  rate        Decimal? @db.Decimal(10, 2)
  amount      Decimal? @db.Decimal(10, 2)
  breakHours  Decimal? @db.Decimal(5, 2)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  timesheet Timesheet @relation(fields: [timesheetId], references: [id], onDelete: Cascade)

  @@index([timesheetId])
  @@map("timesheet_entries")
}

// ====
// PAYMENT SYSTEM (Avec ownership)
// ====
enum PaymentMethodType {
  BANK_ACCOUNT
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  STRIPE
  WISE
  REVOLUT
  OTHER
}

model Payment {
  id         String  @id @default(cuid())
  tenantId   String
  
  // What is being paid
  invoiceId    String?
  expenseId    String?
  payrollRunId String?
  
  // Ownership
  createdBy String // userId
  
  // Payment details
  amount          Decimal @db.Decimal(12, 2)
  currency        String
  status          String  // pending, processing, completed, failed, refunded
  paymentMethod   String
  paymentMethodId String?
  
  // Transaction
  transactionId   String?
  referenceNumber String?
  
  // Dates
  scheduledDate DateTime?
  processedDate DateTime?
  completedDate DateTime?
  
  // Additional
  description String? @db.Text
  notes       String? @db.Text
  metadata    Json?
  
  // Failure
  failureReason String? @db.Text
  retryCount    Int     @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant           Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice          Invoice?       @relation(fields: [invoiceId], references: [id])
  expense          Expense?       @relation(fields: [expenseId], references: [id])
  paymentMethodRel PaymentMethod? @relation(fields: [paymentMethodId], references: [id])

  @@index([tenantId])
  @@index([createdBy])
  @@index([invoiceId])
  @@index([expenseId])
  @@index([status])
  @@map("payments")
}

model PaymentMethod {
  id       String            @id @default(cuid())
  tenantId String
  
  // ðŸ”¥ Owner (simplifiÃ© - toujours un userId maintenant)
  userId   String
  
  // Method details
  type      PaymentMethodType
  isDefault Boolean           @default(false)
  
  // Bank account
  bankName          String?
  accountHolderName String?
  accountNumber     String? // Should be encrypted
  routingNumber     String? // Should be encrypted
  swiftCode         String?
  iban              String?
  
  // Card
  cardLast4      String?
  cardBrand      String?
  cardExpMonth   Int?
  cardExpYear    Int?
  cardholderName String?
  
  // External gateway
  gatewayType  String?
  gatewayToken String?
  
  // Status
  isActive   Boolean   @default(true)
  isVerified Boolean   @default(false)
  verifiedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([tenantId])
  @@index([userId])
  @@map("payment_methods")
}

// ====
// APPROVAL WORKFLOWS
// ====
model ApprovalWorkflow {
  id         String @id @default(cuid())
  tenantId   String
  
  // Entity (polymorphic)
  entityType String // expense, timesheet, contract, etc.
  entityId   String
  
  // Configuration
  workflowType String // single_approver, multi_step, parallel, etc.
  
  // Status
  status           String @default("pending") // pending, in_progress, approved, rejected, cancelled
  currentStepOrder Int    @default(1)
  
  // Final decision
  finalDecision   String?   // approved, rejected
  finalDecisionAt DateTime?
  finalDecisionBy String?   // userId
  
  // Dates
  startedAt   DateTime  @default(now())
  completedAt DateTime?
  
  // Metadata
  metadata Json?
  
  // Ownership
  createdBy String // userId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant     Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  steps      ApprovalStep[]
  expenses   Expense[]
  timesheets Timesheet[] @relation("WorkflowTimesheets")


  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([createdBy])
  @@index([status])
  @@map("approval_workflows")
}

model ApprovalStep {
  id         String @id @default(cuid())
  workflowId String
  
  // Configuration
  stepOrder Int
  stepName  String
  
  // ðŸ”¥ Approver (simplifiÃ© - toujours un userId)
  approverId String
  
  // Status
  status     String    @default("pending") // pending, approved, rejected, skipped
  decision   String?   // approve, reject
  decisionAt DateTime?
  comments   String?   @db.Text
  
  // Rules
  isRequired Boolean @default(true)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workflow ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([approverId])
  @@map("approval_steps")
}

// ====
// DOCUMENT MANAGEMENT
// ====
model Document {
  id        String   @id @default(cuid())
  tenantId  String

  entityType String?
  entityId   String?

  // File storage
  s3Key      String
  fileName   String
  mimeType   String
  fileSize   Int
  fileHash   String?

  fileUrl    String? // signed or cached, optional

  description String? @db.Text
  category    String?

  // Versioning
  version          Int      @default(1)
  isLatestVersion  Boolean  @default(true)
  parentDocumentId String?
  parentDocument   Document?  @relation("DocumentVersions", fields: [parentDocumentId], references: [id])
  versions         Document[] @relation("DocumentVersions")

  visibility String @default("private")

  requiresSignature Boolean  @default(false)
  isSigned          Boolean  @default(false)
  signedAt          DateTime?
  signedBy          String?

  uploadedBy String
  uploadedAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([uploadedBy])
  @@map("documents")
}


// ====
// TAGGING SYSTEM
// ====
model Tag {
  id        String @id @default(cuid())
  tenantId  String
  name      String
  color     String? @default("#3b82f6")
  
  // Ownership
  createdBy String // userId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tagAssignments TagAssignment[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("tags")
}

model TagAssignment {
  id       String @id @default(cuid())
  tenantId String
  tagId    String
  
  // Entity (polymorphic)
  entityType String // contract, invoice, user, etc.
  entityId   String
  
  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([tagId, entityType, entityId])
  @@index([tenantId])
  @@index([entityType, entityId])
  @@map("tag_assignments")
}

// ====
// CUSTOM FIELDS
// ====
model CustomField {
  id         String  @id @default(cuid())
  tenantId   String
  entityType String  // contract, user, invoice, etc.
  fieldName  String
  fieldType  String  // text, number, date, select, multi_select, boolean
  fieldLabel String
  
  // Configuration
  isRequired Boolean @default(false)
  options    Json?   // For select/multi_select fields
  
  // Ownership
  createdBy String // userId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  values CustomFieldValue[]

  @@unique([tenantId, entityType, fieldName])
  @@index([tenantId])
  @@map("custom_fields")
}

model CustomFieldValue {
  id            String @id @default(cuid())
  tenantId      String
  customFieldId String
  
  // Entity (polymorphic)
  entityType String
  entityId   String
  
  // Value
  value Json
  
  // Ownership
  createdBy String // userId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customField CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [createdBy], references: [id])

  @@unique([customFieldId, entityType, entityId])
  @@index([tenantId])
  @@index([entityType, entityId])
  @@map("custom_field_values")
}

// ====
// USER ACTIVITY TRACKING
// ====
model UserActivity {
  id         String  @id @default(cuid())
  tenantId   String
  userId     String
  
  // Activity
  action      String  // login, logout, create, update, delete, view, etc.
  entityType  String? // contract, invoice, etc.
  entityId    String?
  description String? @db.Text
  metadata    Json?
  
  // Context
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("user_activities")
}

// ====
// API KEYS (Version PRO - Enterprise Grade)
// ====
model ApiKey {
  id        String @id @default(cuid())
  tenantId  String

  // Ownership
  createdById String
  revokedById String?
  
  // Key details
  name        String
  description String?

  key       String @unique // Hashed API key
  keyPrefix String         // Visible prefix (e.g., "sk_live_abc123")

  // Access control
  scopes      String[] @default([]) // ex: ["invoices.read", "contracts.write"]
  permissions String[] @default([]) // granular RBAC permissions

  // Security
  allowedIPs String[] @default([]) // Whitelist IPs
  rateLimit  Int?                  // Max req/min

  // Status
  usageCount Int       @default(0)
  isActive   Boolean   @default(true)
  expiresAt  DateTime?
  revokedAt  DateTime?
  lastUsedAt DateTime?

  // Metadata
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User   @relation("ApiKeyCreatedBy", fields: [createdById], references: [id])
  revokedBy User?  @relation("ApiKeyRevokedBy", fields: [revokedById], references: [id])

  @@index([tenantId])
  @@index([keyPrefix])
  @@index([isActive])
  @@index([createdById])
  @@map("api_keys")
}

// ====
// REFERENCE MODELS
// ====
model Currency {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  symbol    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contracts Contract[]

  @@map("currencies")
}

model Country {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companies         Company[]
  users             User[]
  contractCountries Contract[]

  @@map("countries")
}

model Bank {
  id            String  @id @default(cuid())
  tenantId      String
  name          String
  accountNumber String?
  swiftCode     String?
  iban          String?
  address       String?
  
  // Ownership
  createdBy String? // userId
  
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contracts Contract[]

  @@index([tenantId])
  @@index([createdBy])
  @@map("banks")
}

model DocumentType {
  id          String  @id @default(cuid())
  tenantId    String
  name        String
  description String?
  isRequired  Boolean @default(false)
  isActive    Boolean @default(true)
  
  // Ownership
  createdBy String? // userId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("document_types")
}

model Lead {
  id          String    @id @default(cuid())
  tenantId    String
  name        String
  contact     String?
  email       String?
  phone       String?
  status      String    @default("cold")
  source      String?
  value       String?
  lastContact DateTime?
  notes       String?   @db.Text
  
  // Ownership
  createdBy  String? // userId
  assignedTo String? // userId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([createdBy])
  @@index([assignedTo])
  @@map("leads")
}

// ====
// TASKS
// ====
model Task {
  id          String    @id @default(cuid())
  tenantId    String
  title       String
  description String?   @db.Text
  assignedTo  String    // userId
  assignedBy  String    // userId
  priority    String    @default("medium")
  status      String    @default("pending")
  dueDate     DateTime?
  completedAt DateTime?
  isCompleted Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant       Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignedUser User   @relation("TasksAssignedTo", fields: [assignedTo], references: [id], onDelete: Cascade)
  assignerUser User   @relation("TasksAssignedBy", fields: [assignedBy], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([assignedTo])
  @@index([assignedBy])
  @@map("tasks")
}

// ====
// ONBOARDING
// ====
model OnboardingTemplate {
  id          String  @id @default(cuid())
  tenantId    String
  name        String
  description String? @db.Text
  isActive    Boolean @default(true)
  
  // Ownership
  createdBy String? // userId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  questions OnboardingQuestion[]
  users     User[]

  @@index([tenantId])
  @@map("onboarding_templates")
}

model OnboardingQuestion {
  id                   String  @id @default(cuid())
  onboardingTemplateId String
  questionText         String  @db.Text
  questionType         String
  isRequired           Boolean @default(true)
  order                Int
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  template  OnboardingTemplate   @relation(fields: [onboardingTemplateId], references: [id], onDelete: Cascade)
  responses OnboardingResponse[]

  @@index([onboardingTemplateId])
  @@map("onboarding_questions")
}

model OnboardingResponse {
  id               String    @id @default(cuid())
  tenantId         String
  userId           String    // ðŸ”¥ RemplacÃ© contractorId par userId
  questionId       String
  responseText     String?   @db.Text
  responseFilePath String?
  status           String    @default("pending")
  adminNotes       String?   @db.Text
  
  // Review
  reviewedBy String?   // userId
  reviewedAt DateTime?
  
  submittedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant   Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  question OnboardingQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([tenantId])
  @@index([userId])
  @@index([reviewedBy])
  @@map("onboarding_responses")
}

// ====
// PAYSLIP
// ====
model Payslip {
  id            String    @id @default(cuid())
  tenantId      String
  userId        String    // ðŸ”¥ RemplacÃ© contractorId par userId
  contractId    String?
  month         Int
  year          Int
  grossPay      Float
  netPay        Float
  deductions    Float     @default(0)
  tax           Float     @default(0)
  status        String
  generatedDate DateTime  @default(now())
  sentDate      DateTime?
  paidDate      DateTime?
  notes         String?   @db.Text
  
  // Ownership
  generatedBy String? // userId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  contract Contract? @relation(fields: [contractId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([userId])
  @@index([generatedBy])
  @@map("payslips")
}

// ====
// REMITTANCES (Contractor Portal)
// ====
model Remittance {
  id          String   @id @default(cuid())
  tenantId    String
  userId      String   // ðŸ”¥ RemplacÃ© contractorId par userId
  contractId  String?
  amount      Decimal  @db.Decimal(12, 2)
  currency    String   @default("USD")
  status      String   // pending, processing, completed, failed
  
  // Dates
  requestedAt DateTime  @default(now())
  processedAt DateTime?
  completedAt DateTime?
  
  // Details
  description String? @db.Text
  notes       String? @db.Text
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  contract Contract? @relation(fields: [contractId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@index([status])
  @@map("remittances")
}

// ====
// REFERRALS (Contractor Portal)
// ====
model Referral {
  id                   String    @id @default(cuid())
  tenantId             String
  referrerUserId       String    // ðŸ”¥ RemplacÃ© referrerContractorId par referrerUserId
  referredUserId       String?   // ðŸ”¥ RemplacÃ© referredContractorId par referredUserId
  
  // Referral details
  referredEmail  String
  referredName   String?
  status         String  // pending, accepted, rejected, rewarded
  
  // Reward
  rewardAmount   Decimal? @db.Decimal(10, 2)
  rewardCurrency String?  @default("USD")
  rewardPaidAt   DateTime?
  
  // Dates
  referredAt DateTime  @default(now())
  acceptedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant        Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  referrerUser  User   @relation("ReferralsMade", fields: [referrerUserId], references: [id], onDelete: Cascade)
  referredUser  User?  @relation("ReferralsReceived", fields: [referredUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([referrerUserId])
  @@index([referredUserId])
  @@index([status])
  @@map("referrals")
}

// ====
// AUDIT LOG
// ====
model AuditLog {
  id         String  @id @default(cuid())
  tenantId   String?
  userId     String?
  
  // User info (snapshot)
  userName String
  userRole String
  
  // Action
  action     String // CREATE, UPDATE, DELETE, VIEW, EXPORT, etc.
  entityType String
  entityId   String?
  entityName String?
  
  // Details
  description String
  metadata    Json?
  
  // Context
  ipAddress String?
  userAgent String?
  
  createdAt DateTime @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("audit_logs")
}

// ====
// AUTH MODELS
// ====
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_reset_tokens")
}

// ====
// SUPER ADMIN
// ====
model SuperAdmin {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("super_admins")
}

// ====
// WEBHOOKS
// ====
model WebhookSubscription {
  id       String   @id @default(cuid())
  tenantId String
  url      String
  events   String[] // Array of event names
  secret   String   // For HMAC signature
  isActive Boolean  @default(true)
  headers  Json?    // Additional headers
  
  // Ownership
  createdBy String? // userId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  deliveryLogs WebhookDelivery[]

  @@index([tenantId])
  @@map("webhook_subscriptions")
}

model WebhookDelivery {
  id             String    @id @default(cuid())
  subscriptionId String
  event          String
  payload        Json
  statusCode     Int?
  response       String?
  success        Boolean
  attempt        Int       @default(1)
  deliveredAt    DateTime?
  createdAt      DateTime  @default(now())

  subscription WebhookSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([event])
  @@index([createdAt])
  @@map("webhook_deliveries")
}

// ====
// PERMISSION AUDIT TRAIL
// ====
model PermissionAudit {
  id           String   @id @default(cuid())
  tenantId     String?
  userId       String?
  action       String   // GRANT, REVOKE, ROLE_ASSIGNED, ROLE_REMOVED
  resourceType String   // ROLE, PERMISSION, USER
  resourceId   String
  changes      Json     // Details of the change
  performedBy  String   // userId
  createdAt    DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@map("permission_audits")
}

// ====
// EMAIL & SMS TRACKING
// ====
model EmailLog {
  id        String    @id @default(cuid())
  tenantId  String?
  to        String
  from      String
  subject   String
  template  String?
  status    String    // QUEUED, SENT, FAILED, BOUNCED
  messageId String?
  error     String?
  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}

model SMSLog {
  id        String    @id @default(cuid())
  tenantId  String?
  to        String
  from      String
  message   String
  template  String?
  status    String    // QUEUED, SENT, FAILED, DELIVERED
  messageId String?
  error     String?
  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
  @@map("sms_logs")
}

// ====
// NOTIFICATION PREFERENCES
// ====
model NotificationPreference {
  id        String   @id @default(cuid())
  userId    String
  channel   String   // EMAIL, SMS, IN_APP
  event     String   // Event type
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channel, event])
  @@index([userId])
  @@map("notification_preferences")
}

// ====
// SCHEDULED JOBS
// ====
model ScheduledJob {
  id         String    @id @default(cuid())
  tenantId   String?
  name       String
  type       String    // PAYROLL, INVOICE, REPORT, CLEANUP, etc.
  schedule   String    // Cron expression
  isActive   Boolean   @default(true)
  lastRunAt  DateTime?
  nextRunAt  DateTime?
  lastStatus String?   // SUCCESS, FAILED
  lastError  String?
  config     Json?     // Job-specific configuration
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([tenantId])
  @@index([isActive])
  @@index([nextRunAt])
  @@map("scheduled_jobs")
}

// ====
// SYSTEM CONFIGURATION
// ====
model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  category  String
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("system_configs")
}

// ====
// TENANT FEATURE FLAGS
// ====
model TenantFeatureFlag {
  id         String   @id @default(cuid())
  tenantId   String
  featureKey String   // API_ACCESS, CUSTOM_BRANDING, ADVANCED_REPORTING, etc.
  isEnabled  Boolean  @default(false)
  metadata   Json?    // Configuration for the feature
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, featureKey])
  @@index([tenantId])
  @@map("tenant_feature_flags")
}

// ====
// TENANT QUOTAS
// ====
model TenantQuota {
  id                   String   @id @default(cuid())
  tenantId             String   @unique
  maxUsers             Int      @default(10)
  maxStorageGB         Int      @default(5)
  maxContractsPerMonth Int      @default(50)
  maxInvoicesPerMonth  Int      @default(100)
  maxApiCallsPerDay    Int      @default(1000)
  maxEmailsPerMonth    Int      @default(500)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_quotas")
}

// ====
// EMAIL TEMPLATES
// ====
model EmailTemplate {
  id        String  @id @default(cuid())
  tenantId  String
  key       String  // welcome_email, invoice_sent, contract_signed, etc.
  name      String
  subject   String
  body      String  @db.Text // HTML content
  variables Json?   // Available variables
  isActive  Boolean @default(true)
  
  // Ownership
  createdBy String? // userId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("email_templates")
}

// ====
// PDF TEMPLATES
// ====
model PDFTemplate {
  id        String  @id @default(cuid())
  tenantId  String
  key       String  // invoice_template, contract_template, payslip_template, etc.
  name      String
  content   String  @db.Text // HTML/Template content
  variables Json?   // Available variables
  isActive  Boolean @default(true)
  
  // Ownership
  createdBy String? // userId
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("pdf_templates")
}

// ====
// TENANT SECURITY SETTINGS
// ====
model TenantSecuritySettings {
  id       String @id @default(cuid())
  tenantId String @unique
  
  // Password policies
  minPasswordLength   Int     @default(8)
  requireUppercase    Boolean @default(true)
  requireLowercase    Boolean @default(true)
  requireNumbers      Boolean @default(true)
  requireSpecialChars Boolean @default(false)
  passwordExpiryDays  Int?
  
  // Session management
  sessionTimeoutMinutes Int @default(480) // 8 hours
  maxConcurrentSessions Int @default(3)
  
  // Two-factor authentication
  require2FA          Boolean @default(false)
  require2FAForAdmins Boolean @default(true)
  
  // Login policies
  maxLoginAttempts       Int @default(5)
  lockoutDurationMinutes Int @default(30)
  
  // IP restrictions
  allowedIPs String[] // IP whitelist
  blockedIPs String[] // IP blacklist
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_security_settings")
}

// ====
// DATA EXPORTS
// ====
model DataExport {
  id         String  @id @default(cuid())
  tenantId   String
  
  // Export details
  exportType String  // full_backup, invoices, contracts, users, etc.
  status     String  // pending, processing, completed, failed
  format     String  // json, csv, xlsx, pdf
  
  // File
  fileUrl  String?
  fileSize Int?
  
  // Dates
  requestedAt DateTime  @default(now())
  completedAt DateTime?
  expiresAt   DateTime? // Temporary file expiration
  
  // Ownership
  requestedBy String // userId
  
  // Error
  error String? @db.Text
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([requestedBy])
  @@index([status])
  @@map("data_exports")
}
