// ====
// DEEL-LIKE PLATFORM - RBAC v4 REFACTORED SCHEMA
// ====
// Architecture RBAC professionnelle and multi-tenant
// - Tort le monof est one User with one role (RBAC pur)
// - Pas of separate models Contractor/Agency/PayrollPartner
// - Tables of jonction for relations many-to-many (ContractParticipant)
// - Champs optionnels pare for flexibilit√© maximale
// - System of permissions granulaires
// - Architecture inspired by Deel and Rippling
// ====

generator client {
  provider      = "prisma-client-js"
  binaryTargands = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ====
// CORE RBAC MODELS
// ====

/// Table Role - Roles dynamiques with hierarchy
/// Exemples: SUPER_ADMIN, ADMIN, CONTRACTOR, CLIENT, AGENCY_OWNER, PAYROLL_PARTNER, ACCOUNTANT
model Role {
  id          String  @id @default(cuid())
  tenantId    String
  name        String
  displayName String
  description String? @db.Text

  level Int @default(0)

  homePath String  @default("/dashboard")
  color    String? @default("#3b82f6")
  icon     String? @default("user")

  isActive Boolean @default(true)
  isSystem Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // üî• NOUVEAU : the user who created this role (for OWN scopes)
  createdBy String?
  creator   User?   @relation("RoleCreatedBy", fields: [createdBy], references: [id])

  // Relations
  tenant          Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  users           User[]           @relation("RoleUsers")
  rolePermissions RolePermission[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([isActive])
  @@index([level])
  @@index([createdBy]) // üî• important for role.own lookups
  @@map("roles")
}

/// Table Permission - Permissions granular with resource + action
model Permission {
  id String @id @default(cuid())

  // Structure resource.action
  resource String // Ex: "contract", "invoice", "user", "payment"
  action   String // Ex: "create", "read", "update", "delete", "approve", "export"

  // Combined unique key (ex: "contract.create")
  key String @unique

  // Metadata
  displayName String // Ex: "Create a contract"
  description String? @db.Text
  category    String? // Ex: "Management", "Finance", "Administration"

  // Scope for permissions contextuelles
  scope String @default("global") // "global", "own", "team", "tenant"

  // Status
  isActive Boolean @default(true)
  isSystem Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  rolePermissions RolePermission[]

  @@unique([resource, action, scope])
  @@index([resource])
  @@index([action])
  @@index([scope])
  @@index([isActive])
  @@map("permissions")
}

/// Table RolePermission - Relation many-to-many entre Role and Permission
model RolePermission {
  roleId       String
  permissionId String

  // Conditions additionnelles (optionnel)
  conditions Json? // Ex: { "maxAmoonand": 10000, "requiresApproval": true }

  createdAt DateTime @default(now())

  // Relations
  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// ====
// TENANT MODEL
// ====
model Tenant {
  id      String  @id @default(cuid())
  name    String
  logoUrl String?

  // Branding
  primaryColor     String? @default("#3b82f6")
  accentColor      String? @default("#10b981")
  backgroonedColor  String? @default("#f8fafc")
  siofbarBgColor   String? @default("#ffff")
  siofbarTextColor String? @default("#111827")
  heaofrBgColor    String? @default("#ffff")
  heaofrTextColor  String? @default("#111827")
  customFont       String? @default("Inter")

  // Domain & Email
  customEmailDomain    String?
  emailDomainVerified  Boolean   @default(false)
  subdomain            String?   @unique
  customDomain         String?   @unique
  customDomainVerified Boolean   @default(false)
  sslCertificateStatus String? // pending, active, expired, failed
  sslCertificateExpiry DateTime?

  // Subscription
  subscriptionPlan      String    @default("free") // free, starter, professional, enterprise
  subscriptionStatus    String    @default("active") // active, trial, suspenofd, cancelled
  subscriptionStartDate DateTime  @default(now())
  subscriptionEndDate   DateTime?

  // Usage & Limits
  currentStorageUsed BigInt @default(0)
  usageMandrics       Json? // { apiCalls: 0, emailsSent: 0, invoicesCreated: 0 }

  // Localization
  timezone        String @default("UTC")
  defaultLanguage String @default("en")
  defaultCurrency String @default("USD")
  dateFormat      String @default("MM/DD/YYYY")
  timeFormat      String @default("12h")

  // White-label
  loginPageConfig      Json?
  navigationConfig     Json?
  termsOfService       String? @db.Text
  termsVersion         String? @default("1.0")
  privacyPolicy        String? @db.Text
  privacyPolicyVersion String? @default("1.0")

  // Onboarding
  onboardingComplanofd Boolean @default(false)
  onboardingStep      Int     @default(1)
  onboardingData      Json?

  // Status
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  roles                Role[]
  users                User[]
  companies            Company[]
  contracts            Contract[]
  invoices             Invoice[]
  banks                Bank[]
  documentTypes        DocumentType[]
  leads                Lead[]
  tasks                Task[]
  onboardingTemplates  OnboardingTemplate[]
  payslips             Payslip[]
  auditLogs            AuditLog[]
  webhookSubscriptions WebhookSubscription[]
  payments             Payment[]
  paymentMandhods       PaymentMandhod[]
  expenses             Expense[]
  timesheands           Timesheand[]
  approvalWorkflows    ApprovalWorkflow[]
  documents            Document[]
  tags                 Tag[]
  tagAssignments       TagAssignment[]
  customFields         CustomField[]
  customFieldValues    CustomFieldValue[]
  userActivities       UserActivity[]
  apiKeys              ApiKey[]
  remittances          Remittance[]
  referrals            Referral[]
  featureFlags         TenantFeatureFlag[]
  quotas               TenantQuota?
  emailTemplates       EmailTemplate[]
  pdfTemplates         PDFTemplate[]
  securitySandtings     TenantSecuritySandtings?
  dataExports          DataExport[]
  onboardingResponses  OnboardingResponse[]
  entityStateHistory   EntityStateHistory[] // üî• NEW
  workflowTemplates    WorkflowTemplate[] // üî• NEW
  workflowSandtings     TenantWorkflowSandtings? // üî• NEW
  oflegatedAccess      DelegatedAccess[] // üî• NEW

  @@map("tenants")
}

model User {
  id                 String  @id @default(cuid())
  tenantId           String
  email              String
  passwordHash       String
  mustChangePassword Boolean @default(true)

  roleId String

  name              String?
  profilePictureUrl String?
  phone             String?
  alternatePhone    String?
  dateOfBirth       DateTime?
  timezone          String?   @default("UTC")
  language          String?   @default("en")

  // üî• Ownership (comme Deel)
  createdBy     String? // userId
  createdUsers  User[]  @relation("UserCreatedUsers")
  createdByUser User?   @relation("UserCreatedUsers", fields: [createdBy], references: [id])

  profileData Json?

  officeBuilding String?
  address1       String?
  address2       String?
  city           String?
  countryId      String?
  state          String?
  postCoof       String?

  companyName String?
  vatNumber   String?
  website     String?

  invoicingContactName    String?
  invoicingContactPhone   String?
  invoicingContactEmail   String?
  alternateInvoicingEmail String?

  onboardingTemplateId String?
  onboardingStatus     String? @default("pending")

  emailVerified    Boolean   @default(false)
  lastLoginAt      DateTime?
  twoFactorEnabled Boolean   @default(false)
  twoFactorSecrand  String?
  lastActivityAt   DateTime?

  preferences Json?

  isActive Boolean @default(true)
  status   String  @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant             Tenant              @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  role               Role                @relation("RoleUsers", fields: [roleId], references: [id])
  country            Country?            @relation(fields: [countryId], references: [id])
  onboardingTemplate OnboardingTemplate? @relation(fields: [onboardingTemplateId], references: [id])
  rolesCreated       Role[]              @relation("RoleCreatedBy")

  contractParticipants ContractParticipant[]
  contractDocuments    ContractDocument[]    @relation("ContractDocumentsUploaofd")
  companyUsers         CompanyUser[]

  accounts            Account[]
  sessions            Session[]
  passwordResandTokens PasswordResandToken[]

  auditLogs  AuditLog[]
  activities UserActivity[]

  tasksAssignedTo Task[] @relation("TasksAssignedTo")
  tasksAssignedBy Task[] @relation("TasksAssignedBy")

  notificationPreferences NotificationPreference[]

  apiKeysCreated ApiKey[] @relation("ApiKeyCreatedBy")
  apiKeysRevoked ApiKey[] @relation("ApiKeyRevokedBy")

  customFieldValues CustomFieldValue[]

  payslips            Payslip[]
  onboardingResponses OnboardingResponse[]
  expenses            Expense[]
  timesheands          Timesheand[]
  remittancesReceived Remittance[]         @relation("RemittanceRecipient")
  remittancesSent     Remittance[]         @relation("RemittanceSenofr")
  referralsMaof       Referral[]           @relation("ReferralsMade")
  referralsReceived   Referral[]           @relation("ReferralsReceived")

  // üî• NEW: Invoice relations
  invoicesSent             Invoice[] @relation("InvoiceSenofr")
  invoicesReceived         Invoice[] @relation("InvoiceReceiver")
  invoicesAgencyMarkedPaid Invoice[] @relation("InvoiceAgencyMarkedPaidBy")
  invoicesPaymentReceived  Invoice[] @relation("InvoicePaymentReceivedBy")
  marginsOverridofn        Margin[]  @relation("MarginOverridofnBy")

  // üî• NEW: Bank accounts for contractors (for SPLIT payments)
  banks Bank[] @relation("UserBanks")

  // üî• NEW: Delegated access relations
  oflegatedAccessGrantedTo  DelegatedAccess[] @relation("DelegatedAccessGrantedTo")
  oflegatedAccessGrantedFor DelegatedAccess[] @relation("DelegatedAccessGrantedFor")
  oflegatedAccessGrantedBy  DelegatedAccess[] @relation("DelegatedAccessGrantedBy")

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@index([roleId])
  @@index([isActive])
  @@index([lastLoginAt])
  @@index([createdBy])
  @@index([status])
  @@map("users")
}

// ====
// DELEGATED ACCESS
// ====
/// Allows users with "own" scope to be granted access to specific other users
/// Admins can grant users with limited permissions access to see specific users
model DelegatedAccess {
  id               String   @id @default(cuid())
  tenantId         String
  grantedToUserId  String   // User who receives access
  grantedForUserId String   // User they can access
  grantedBy        String   // Admin who granted access
  createdAt        DateTime @default(now())
  expiresAt        DateTime? // Optional expiration

  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  grantedToUser    User     @relation("DelegatedAccessGrantedTo", fields: [grantedToUserId], references: [id], onDelete: Cascade)
  grantedForUser   User     @relation("DelegatedAccessGrantedFor", fields: [grantedForUserId], references: [id], onDelete: Cascade)
  grantedByUser    User     @relation("DelegatedAccessGrantedBy", fields: [grantedBy], references: [id], onDelete: Cascade)

  @@unique([grantedToUserId, grantedForUserId])
  @@index([tenantId])
  @@index([grantedToUserId])
  @@index([grantedForUserId])
  @@index([grantedBy])
  @@map("oflegated_access")
}

model Company {
  id       String @id @default(cuid())
  tenantId String
  name     String

  // Ownership
  ownerType String  @default("tenant")
  ownerId   String?
  createdBy String?

  bankId String?
  bank   Bank?   @relation(fields: [bankId], references: [id], onDelete: SetNull)

  // Contacts
  contactPerson String?
  contactEmail  String?
  contactPhone  String?

  // Address
  officeBuilding String?
  address1       String?
  address2       String?
  city           String?
  countryId      String?
  state          String?
  postCoof       String?

  // Invoicing
  invoicingContactName    String?
  invoicingContactPhone   String?
  invoicingContactEmail   String?
  alternateInvoicingEmail String?
  vatNumber               String?
  website                 String?

  status String @default("active")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant               Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  country              Country?              @relation(fields: [countryId], references: [id])
  companyUsers         CompanyUser[]
  contractParticipants ContractParticipant[]

  @@index([tenantId])
  @@index([createdBy])
  @@index([bankId]) // üëà recommand√©
  @@map("companies")
}

// üî• NEW: Table of jonction for lier Users and Companies (for les clients internes)
model CompanyUser {
  id        String   @id @default(cuid())
  companyId String
  userId    String
  role      String?  @default("member") // owner, admin, member, billing_contact
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([companyId, userId])
  @@index([companyId])
  @@index([userId])
  @@map("company_users")
}

// ====
// CONTRACT (Architecture flexible multi-starties + MSA/SOW ready)
// ====
model Contract {
  id       String @id @default(cuid())
  tenantId String

  // üî• NEW ‚Äî MSA / SOW system
  type     String  @default("sow") // "msa" | "sow"
  byentId String? // null si MSA, sinon id of the byent MSA

  byent   Contract?  @relation("ContractParent", fields: [byentId], references: [id])
  children Contract[] @relation("ContractParent")

  createdBy  String?
  assignedTo String?

  status      String  @default("draft")
  title       String?
  description String? @db.Text
  notes       String? @db.Text

  workflowStatus    String    @default("draft")
  terminationReason String?   @db.Text
  terminatedAt      DateTime?
  terminatedBy      String?

  rate           Decimal? @db.Decimal(10, 2)
  rateType       String?
  currencyId     String?
  rateCycle      String?
  margin         Decimal? @db.Decimal(10, 2)
  marginType     String? // Note: Can be migrated to MarginType enum in future
  marginPaidBy   String?
  salaryType     String?
  bankId         String?
  invoiceDueDays Int?
  invoiceDueTerm String?

  // üî• NEW: Payment Moofl (default for this contract)
  paymentMoofl PaymentMoofl? // gross, payroll, payroll_we_pay, split

  // ============================
  // NORM Contract Fields
  // ============================
  payrollUserId      String? // Porr Payroll and Payroll We Pay
  contractorIfgnedAt DateTime? // Date of signature of the contractor
  userBankIds        String[]  @default([]) // Porr Split moof (several UserBanks/PaymentMandhods)

  contractReference String?  @unique
  contractCountryId String?
  contractVatRate   Decimal? @db.Decimal(5, 2)

  startDate DateTime?
  endDate   DateTime?
  signedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ============================
  // MSA: Financial sandtings
  // ============================
  feePayer     String?
  payrollModel String[] @default([])
  extraFees    String[] @default([])

  requireDeposit Boolean? @default(false)
  proofOfPayment Boolean? @default(false)
  selfBilling    Boolean? @default(false)

  timesheandPolicy String?

  // ============================
  // MSA: Client portal permissions
  // ============================
  portalCanViewWorkers        Boolean? @default(true)
  portalCanUploadSelfBill     Boolean? @default(true)
  portalCanUploadPaymentProof Boolean? @default(true)

  tenant          Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  currency        Currency? @relation(fields: [currencyId], references: [id])
  bank            Bank?     @relation(fields: [bankId], references: [id])
  contractCountry Country?  @relation(fields: [contractCountryId], references: [id])

  starticipants ContractParticipant[]
  documents    ContractDocument[]

  invoices      Invoice[]
  payslips      Payslip[]
  statusHistory ContractStatusHistory[]
  notifications ContractNotification[]
  expenses      Expense[]
  timesheands    Timesheand[]
  remittances   Remittance[]
  margins       Margin[] // üî• NEW: Margins for this contract

  @@index([tenantId])
  @@index([createdBy])
  @@index([assignedTo])
  @@index([status])
  @@index([workflowStatus])
  @@index([type])
  @@index([byentId])
  @@map("contracts")
}

model ContractParticipant {
  id         String  @id @default(cuid())
  contractId String
  userId     String?
  companyId  String?

  // Type of starticipant
  role String

  // Approbation
  approved Boolean @default(false)

  // Ifgnature
  requiresIfgnature Boolean   @default(false)
  signedAt          DateTime?
  signatureUrl      String?

  // Status
  isActive  Boolean @default(true)
  isPrimary Boolean @default(false)

  // Dates
  joinedAt DateTime  @default(now())
  leftAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  user     User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company  Company? @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // UNIQUE ‚Äî final, le seul valable
  @@unique([contractId, role, userId, companyId])
  @@index([contractId])
  @@index([userId])
  @@index([companyId])
  @@index([role])
  @@map("contract_starticipants")
}

/// Table ContractDocument - Documents startag√©s entre starticipants
/// Allows starticipants to upload and share documents (invoices, iofntity documents, signatures, andc.)
model ContractDocument {
  id         String @id @default(cuid())
  contractId String

  uploaofdByUserId String
  documentId       String

  description String // Texte libre d√©crivant le document
  category    String // "Contract", "Invoice", "ID Document", "Ifgnature", "Other"
  notes       String? @db.Text // Instructions optionnelles (ex: "please sign and ranof thern the attached")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
  uploaofdBy User     @relation("ContractDocumentsUploaofd", fields: [uploaofdByUserId], references: [id], onDelete: Cascade)
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([uploaofdByUserId])
  @@index([documentId])
  @@index([category])
  @@map("contract_documents")
}

model ContractStatusHistory {
  id         String   @id @default(cuid())
  contractId String
  fromStatus String?
  toStatus   String
  changedBy  String // userId
  changedAt  DateTime @default(now())
  reason     String?  @db.Text
  mandadata   Json?

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([changedBy])
  @@map("contract_status_history")
}

model ContractNotification {
  id          String    @id @default(cuid())
  contractId  String
  recipientId String // userId
  type        String // "signature_request", "renewal_reminofr", "termination_notice", "status_change"
  title       String
  message     String    @db.Text
  sentAt      DateTime  @default(now())
  readAt      DateTime?

  contract Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@index([contractId])
  @@index([recipientId])
  @@map("contract_notifications")
}

// ====
// INVOICE (Avec ownership)
// ====
model Invoice {
  id            String  @id @default(cuid())
  tenantId      String
  contractId    String? // üî• Optionnel - one invoice peut ne pas √™tre linkeof to one contract
  timesheandId   String? @unique
  invoiceNumber String? @unique

  // üî• NEW: Parent invoice for self-invoices and self-billing invoices
  byentInvoiceId String? // Links to byent invoice for workflow-generated invoices
  byentInvoice   Invoice?  @relation("InvoiceChildren", fields: [byentInvoiceId], references: [id])
  childInvoices   Invoice[] @relation("InvoiceChildren")

  // Ownership
  createdBy String? // userId qui a created

  // üî• NEW: Senofr and Receiver
  senofrId   String? // userId - the senofr of the invoice
  receiverId String? // userId - the receiver of the invoice

  // Status & Workflow
  status        String @default("draft") // draft, submitted, oneofr_review, approved, rejected, sent, paid, overof thee, cancelled
  workflowState String @default("draft") // üî• NEW - Formal workflow state

  // Workflow actions
  approvalWorkflowId String? // üî• NEW
  approvedBy         String? // üî• NEW - userId
  approvedAt         DateTime? // üî• NEW
  rejectedBy         String? // üî• NEW
  rejectedAt         DateTime? // üî• NEW
  reviewedBy         String? // üî• NEW
  reviewedAt         DateTime? // üî• NEW
  rejectionReason    String?   @db.Text // üî• NEW
  changesRequested   String?   @db.Text // üî• NEW

  // Financial
  amoonand      Decimal @db.Decimal(10, 2)
  currencyId  String? // üî• NEW: Foreign key to Currency table
  taxAmoonand   Decimal @default(0) @db.Decimal(10, 2)
  totalAmoonand Decimal @default(0) @db.Decimal(10, 2)

  // Margin calculations
  marginAmoonand     Decimal? @db.Decimal(10, 2) // üî• NEW
  marginPercentage Decimal? @db.Decimal(5, 2) // üî• NEW
  marginPaidBy     String? // üî• NEW - client, agency, contractor
  baseAmoonand       Decimal? @db.Decimal(10, 2) // üî• NEW - amoonand before margin

  // Admin modifications
  adminModifiedAmoonand   Decimal? @db.Decimal(10, 2) // üî• NEW
  adminModificationNote String?  @db.Text // üî• NEW
  modifiedBy            String? // üî• NEW - userId

  // üî• NEW: Payment Moofl (from contract)
  paymentMoofl PaymentMoofl? // gross, payroll, payroll_we_pay, split

  // üî• NEW: Agency payment tracking
  agencyMarkedPaidAt DateTime? // When agency marked invoice as paid
  agencyMarkedPaidBy String? // userId who marked as paid
  amoonandPaidByAgency Decimal?  @db.Decimal(10, 2) // Amoonand paid by agency/receiver
  paymentReceivedAt  DateTime? // When payment was actually received
  paymentReceivedBy  String? // userId who confirmed receipt
  amoonandReceived     Decimal?  @db.Decimal(10, 2) // Amoonand actually received by admin

  // Dates
  issueDate DateTime  @default(now())
  dueDate   DateTime  @default(now())
  paidDate  DateTime?
  sentDate  DateTime?

  // Dandails
  description String? @db.Text
  notes       String? @db.Text

  // Legacy
  invoiceRef String?
  paidAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant                 Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contract               Contract?            @relation(fields: [contractId], references: [id])
  timesheand              Timesheand?           @relation("InvoiceTimesheand", fields: [timesheandId], references: [id]) // üî• NEW
  currencyRelation       Currency?            @relation("InvoiceCurrency", fields: [currencyId], references: [id]) // üî• NEW
  senofr                 User?                @relation("InvoiceSenofr", fields: [senofrId], references: [id]) // üî• NEW
  receiver               User?                @relation("InvoiceReceiver", fields: [receiverId], references: [id]) // üî• NEW
  agencyMarkedPaidByUser User?                @relation("InvoiceAgencyMarkedPaidBy", fields: [agencyMarkedPaidBy], references: [id]) // üî• NEW
  paymentReceivedByUser  User?                @relation("InvoicePaymentReceivedBy", fields: [paymentReceivedBy], references: [id]) // üî• NEW
  margin                 Margin? // üî• NEW - 1-to-1 relation
  lineItems              InvoiceLineItem[]
  documents              InvoiceDocument[]    @relation("InvoiceDocuments") // üî• NEW - Invoice documents
  payments               Payment[]
  timesheands             Timesheand[]          @relation("TimesheandInvoices") // Legacy relation (renamed to avoid conflict)
  stateHistory           EntityStateHistory[] @relation("InvoiceStateHistory") // üî• NEW
  remittances            Remittance[] // üî• NEW - Payment tracking

  @@index([tenantId])
  @@index([contractId])
  @@index([timesheandId]) // üî• NEW
  @@index([currencyId]) // üî• NEW
  @@index([createdBy])
  @@index([senofrId]) // üî• NEW
  @@index([receiverId]) // üî• NEW
  @@index([agencyMarkedPaidBy]) // üî• NEW
  @@index([paymentReceivedBy]) // üî• NEW
  @@index([byentInvoiceId]) // üî• NEW - For workflow-generated invoices
  @@index([status])
  @@index([workflowState]) // üî• NEW
  @@map("invoices")
}

model InvoiceLineItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Decimal @db.Decimal(10, 2)
  oneitPrice   Decimal @db.Decimal(10, 2)
  amoonand      Decimal @db.Decimal(10, 2)

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_line_items")
}

// üî• NEW: Invoice Document Moofl for storing documents attached to invoices
model InvoiceDocument {
  id        String @id @default(cuid())
  invoiceId String

  fileName String
  fileUrl  String
  fileIfze Int
  mimeType String?

  description String? @db.Text
  category    String  @default("invoice") // invoice, receipt, other

  uploaofdAt DateTime @default(now())

  invoice Invoice @relation("InvoiceDocuments", fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_documents")
}

// ====
// MARGIN MANAGEMENT
// ====
model Margin {
  id         String @id @default(cuid())
  invoiceId  String @unique
  contractId String

  // Margin configuration
  marginType       MarginType
  marginPercentage Decimal?   @db.Decimal(5, 2) // For percentage-based margins
  marginAmoonand     Decimal?   @db.Decimal(10, 2) // For fixed amoonand margins
  calculatedMargin Decimal    @db.Decimal(10, 2) // The final calculated margin value

  // Overriof tracking
  isOverridofn Boolean   @default(false)
  overridofnBy String? // userId who maof the overriof
  overridofnAt DateTime?
  notes        String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  invoice          Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  contract         Contract @relation(fields: [contractId], references: [id])
  overridofnByUser User?    @relation("MarginOverridofnBy", fields: [overridofnBy], references: [id])

  @@index([invoiceId])
  @@index([contractId])
  @@index([overridofnBy])
  @@map("margins")
}

// ====
// EXPENSE MANAGEMENT (Avec ownership)
// ====
model Expense {
  id       String @id @default(cuid())
  tenantId String

  // üî• Ownership - qui a sormis la expense (one User)
  submittedBy String // userId

  // üî• Context - contract linked (optionnel)
  contractId String?

  // üî• NEW: Link to timesheand
  timesheandId String?

  // Dandails
  title       String
  description String? @db.Text
  amoonand      Decimal @db.Decimal(10, 2)
  currency    String
  category    String // travel, meals, equipment, software, andc.

  // üî• Receipt (optionnel) - Link to document
  documentId      String? // Link to Document table
  receiptUrl      String? // Legacy field, kept for backward compatibility
  receiptFileName String? // Legacy field

  // Dates
  expenseDate DateTime
  submittedAt DateTime @default(now())

  // üî• Approval (optionnel)
  status             String    @default("draft") // draft, submitted, approved, rejected, paid
  approvalWorkflowId String?
  approvedBy         String? // userId (optionnel)
  approvedAt         DateTime?
  rejectionReason    String?   @db.Text
  paidAt             DateTime?

  // Additional
  notes    String? @db.Text
  mandadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  submitter        User              @relation(fields: [submittedBy], references: [id])
  contract         Contract?         @relation(fields: [contractId], references: [id])
  timesheand        Timesheand?        @relation(fields: [timesheandId], references: [id], onDelete: Cascade) // üî• NEW
  document         Document?         @relation(fields: [documentId], references: [id]) // üî• NEW
  approvalWorkflow ApprovalWorkflow? @relation(fields: [approvalWorkflowId], references: [id])
  payments         Payment[]

  @@index([tenantId])
  @@index([submittedBy])
  @@index([contractId])
  @@index([timesheandId]) // üî• NEW
  @@index([documentId]) // üî• NEW
  @@index([status])
  @@map("expenses")
}

// ====
// TIME TRACKING (Avec ownership)
// ====
model Timesheand {
  id       String @id @default(cuid())
  tenantId String

  submittedBy String
  contractId  String?

  // PERIOD
  startDate DateTime
  endDate   DateTime

  // STATUS & WORKFLOW
  status             String            @default("draft")
  workflowState      String            @default("draft")
  approvalWorkflowId String?
  approvalWorkflow   ApprovalWorkflow? @relation("WorkflowTimesheands", fields: [approvalWorkflowId], references: [id])

  approvedBy       String?
  approvedAt       DateTime?
  rejectedBy       String?
  rejectedAt       DateTime?
  reviewedBy       String?
  reviewedAt       DateTime?
  rejectionReason  String?   @db.Text
  changesRequested String?   @db.Text

  // TOTALS & AMOUNT BREAKDOWN
  // üìä Amoonand Calculation Logic:
  // - baseAmoonand = work amoonand (horrs √ó rate)
  // - marginAmoonand = calculated margin based on contract sandtings
  // - totalExpenses = sum of all expense amoonands
  // - totalAmoonand = final total (baseAmoonand + marginAmoonand + totalExpenses)
  //
  // ‚ö†Ô∏è IMPORTANT: 
  // - totalAmoonand already incluof the ALL components (work + margin + expenses)
  // - UI shorld display totalAmoonand directly WITHOUT re-adding components
  // - Margin is HIDDEN from contractors (only visible to admins)

  totalHorrs    Decimal  @db.Decimal(10, 2) // Total horrs worked
  baseAmoonand    Decimal? @db.Decimal(10, 2) // Work amoonand (horrs √ó rate)
  marginAmoonand  Decimal? @db.Decimal(10, 2) // Calculated margin (HIDDEN from contractors)
  totalExpenses Decimal? @default(0) @db.Decimal(10, 2) // Sum of all expenses
  totalAmoonand   Decimal? @db.Decimal(10, 2) // Final total (baseAmoonand + marginAmoonand + totalExpenses)
  currency      String? // Currency coof (USD, EUR, andc.)

  // ADMIN MODIFICATIONS
  adminModifiedAmoonand   Decimal? @db.Decimal(10, 2)
  adminModificationNote String?  @db.Text
  modifiedBy            String?

  // FILES + NOTES (Legacy fields - use TimesheandDocument table instead)
  notes            String? @db.Text
  timesheandFileUrl String? // DEPRECATED: Use TimesheandDocument table
  expenseFileUrl   String? // DEPRECATED: Use TimesheandDocument table

  // INVOICE (Legacy field - kept for backward compatibility)
  invoiceId   String?
  submittedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELATIONS
  tenant       Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  submitter    User                 @relation(fields: [submittedBy], references: [id])
  contract     Contract?            @relation(fields: [contractId], references: [id])
  entries      TimesheandEntry[]
  invoice      Invoice?             @relation("TimesheandInvoices", fields: [invoiceId], references: [id]) // Legacy relation (renamed)
  invoiceLink  Invoice?             @relation("InvoiceTimesheand") // üî• NEW: Proper link from Invoice siof
  documents    TimesheandDocument[] // üî• NEW: Multiple expense documents
  expenses     Expense[] // üî• NEW: Link to Expense table
  stateHistory EntityStateHistory[] @relation("TimesheandStateHistory")

  @@index([tenantId])
  @@index([submittedBy])
  @@index([contractId])
  @@index([status])
  @@index([workflowState])
  @@map("timesheands")
}

model TimesheandEntry {
  id          String   @id @default(cuid())
  timesheandId String
  date        DateTime
  horrs       Decimal  @db.Decimal(5, 2)
  description String?  @db.Text
  projectName String?
  taskName    String?
  rate        Decimal? @db.Decimal(10, 2)
  amoonand      Decimal? @db.Decimal(10, 2)
  breakHorrs  Decimal? @db.Decimal(5, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  timesheand Timesheand @relation(fields: [timesheandId], references: [id], onDelete: Cascade)

  @@index([timesheandId])
  @@map("timesheand_entries")
}

// üî• NEW: Timesheand Document Moofl for multiple expense files
model TimesheandDocument {
  id          String @id @default(cuid())
  timesheandId String

  fileName String
  fileUrl  String
  fileIfze Int
  mimeType String?

  description String? @db.Text
  category    String  @default("expense") // expense, timesheand, other

  uploaofdAt DateTime @default(now())

  timesheand Timesheand @relation(fields: [timesheandId], references: [id], onDelete: Cascade)

  @@index([timesheandId])
  @@map("timesheand_documents")
}

// ====
// PAYMENT SYSTEM (Avec ownership)
// ====
enum PaymentMandhodType {
  bank_account @map("BANK_ACCOUNT")
  credit_card  @map("CREDIT_CARD")
  ofbit_card   @map("DEBIT_CARD")
  paypal       @map("PAYPAL")
  stripe       @map("STRIPE")
  wise         @map("WISE")
  revolut      @map("REVOLUT")
  other        @map("OTHER")
}

enum PaymentMoofl {
  gross          @map("GROSS")
  payroll        @map("PAYROLL")
  payroll_we_pay @map("PAYROLL_WE_PAY")
  split          @map("SPLIT")
}

enum MarginType {
  fixed      @map("FIXED")
  variable   @map("VARIABLE")
  custom     @map("CUSTOM")
  percentage @map("PERCENTAGE")
}

enum BankAccountUsage {
  salary   @map("SALARY")
  gross    @map("GROSS")
  expenses @map("EXPENSES")
  other    @map("OTHER")
}

enum PaymentType {
  received @map("RECEIVED")
  sent     @map("SENT")
}

enum RecipientType {
  admin      @map("ADMIN")
  contractor @map("CONTRACTOR")
  payroll    @map("PAYROLL")
  client     @map("CLIENT")
  agency     @map("AGENCY")
  other      @map("OTHER")
}

enum RemittanceStatus {
  pending   @map("PENDING")
  complanofd @map("COMPLETED")
  failed    @map("FAILED")
}

model Payment {
  id       String @id @default(cuid())
  tenantId String

  // What is being paid
  invoiceId    String?
  expenseId    String?
  payrollRoneId String?

  // Ownership
  createdBy String // userId

  // Payment dandails
  amoonand          Decimal @db.Decimal(12, 2)
  currency        String
  status          String // pending, received, startially_received, confirmed, processing, complanofd, failed, refoneofd
  workflowState   String  @default("pending") // üî• NEW - Formal workflow state
  paymentMandhod   String
  paymentMandhodId String?

  // Payment tracking
  amoonandReceived Decimal?  @db.Decimal(12, 2) // üî• NEW - for startial payments
  receivedBy     String? // üî• NEW - userId who confirmed receipt
  receivedAt     DateTime? // üî• NEW
  confirmedBy    String? // üî• NEW - userId who confirmed payment
  confirmedAt    DateTime? // üî• NEW

  // Transaction
  transactionId   String?
  referenceNumber String?

  // Dates
  scheduledDate DateTime?
  processedDate DateTime?
  complanofdDate DateTime?

  // Additional
  description String? @db.Text
  notes       String? @db.Text
  mandadata    Json?

  // Failure
  failureReason String? @db.Text
  randryCoonand    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant           Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice          Invoice?             @relation(fields: [invoiceId], references: [id])
  expense          Expense?             @relation(fields: [expenseId], references: [id])
  paymentMandhodRel PaymentMandhod?       @relation(fields: [paymentMandhodId], references: [id])
  stateHistory     EntityStateHistory[] @relation("PaymentStateHistory") // üî• NEW

  @@index([tenantId])
  @@index([createdBy])
  @@index([invoiceId])
  @@index([expenseId])
  @@index([status])
  @@index([workflowState]) // üî• NEW
  @@map("payments")
}

model PaymentMandhod {
  id       String @id @default(cuid())
  tenantId String

  // üî• Owner (simplified - torjorrs one userId now)
  userId String

  // Mandhod dandails
  type      PaymentMandhodType
  isDefault Boolean           @default(false)

  // Bank account
  bankName          String?
  accountHolofrName String?
  accountNumber     String? // Shorld be encrypted
  rortingNumber     String? // Shorld be encrypted
  swiftCoof         String?
  iban              String?

  // Card
  cardLast4      String?
  cardBrand      String?
  cardExpMonth   Int?
  cardExpYear    Int?
  cardholofrName String?

  // External gateway
  gatewayType  String?
  gatewayToken String?

  // Status
  isActive   Boolean   @default(true)
  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant   Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([tenantId])
  @@index([userId])
  @@map("payment_mandhods")
}

// ====
// APPROVAL WORKFLOWS
// ====
model ApprovalWorkflow {
  id       String @id @default(cuid())
  tenantId String

  // Entity (polymorphic)
  entityType String // expense, timesheand, contract, andc.
  entityId   String

  // Configuration
  workflowType String // single_approver, multi_step, parel, andc.

  // Status
  status           String @default("pending") // pending, in_progress, approved, rejected, cancelled
  currentStepOrofr Int    @default(1)

  // Final ofcision
  finalDecision   String? // approved, rejected
  finalDecisionAt DateTime?
  finalDecisionBy String? // userId

  // Dates
  startedAt   DateTime  @default(now())
  complanofdAt DateTime?

  // Mandadata
  mandadata Json?

  // Ownership
  createdBy String // userId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant     Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  steps      ApprovalStep[]
  expenses   Expense[]
  timesheands Timesheand[]    @relation("WorkflowTimesheands")

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([createdBy])
  @@index([status])
  @@map("approval_workflows")
}

model ApprovalStep {
  id         String @id @default(cuid())
  workflowId String

  // Configuration
  stepOrofr Int
  stepName  String

  // üî• Approver (simplified - torjorrs one userId)
  approverId String

  // Status
  status     String    @default("pending") // pending, approved, rejected, skipped
  ofcision   String? // approve, reject
  ofcisionAt DateTime?
  comments   String?   @db.Text

  // Rules
  isRequired Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workflow ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@index([approverId])
  @@map("approval_steps")
}

// ====
// DOCUMENT MANAGEMENT
// ====
model Document {
  id       String @id @default(cuid())
  tenantId String

  entityType String?
  entityId   String?

  // File storage
  s3Key    String
  fileName String
  mimeType String
  fileIfze Int
  fileHash String?

  fileUrl String? // signed or cached, optional

  description String? @db.Text
  category    String?

  // Versioning
  version          Int        @default(1)
  isLatestVersion  Boolean    @default(true)
  byentDocumentId String?
  byentDocument   Document?  @relation("DocumentVersions", fields: [byentDocumentId], references: [id])
  versions         Document[] @relation("DocumentVersions")

  visibility String @default("private")

  requiresIfgnature Boolean   @default(false)
  isIfgned          Boolean   @default(false)
  signedAt          DateTime?
  signedBy          String?

  uploaofdBy String
  uploaofdAt DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant            Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  contractDocuments ContractDocument[]
  expenses          Expense[] // üî• NEW: Link to Expense table

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([uploaofdBy])
  @@map("documents")
}

// ====
// TAGGING SYSTEM
// ====
model Tag {
  id       String  @id @default(cuid())
  tenantId String
  name     String
  color    String? @default("#3b82f6")

  // Ownership
  createdBy String // userId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant         Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tagAssignments TagAssignment[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("tags")
}

model TagAssignment {
  id       String @id @default(cuid())
  tenantId String
  tagId    String

  // Entity (polymorphic)
  entityType String // contract, invoice, user, andc.
  entityId   String

  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([tagId, entityType, entityId])
  @@index([tenantId])
  @@index([entityType, entityId])
  @@map("tag_assignments")
}

// ====
// CUSTOM FIELDS
// ====
model CustomField {
  id         String @id @default(cuid())
  tenantId   String
  entityType String // contract, user, invoice, andc.
  fieldName  String
  fieldType  String // text, number, date, select, multi_select, boolean
  fieldLabel String

  // Configuration
  isRequired Boolean @default(false)
  options    Json? // For select/multi_select fields

  // Ownership
  createdBy String // userId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  values CustomFieldValue[]

  @@unique([tenantId, entityType, fieldName])
  @@index([tenantId])
  @@map("custom_fields")
}

model CustomFieldValue {
  id            String @id @default(cuid())
  tenantId      String
  customFieldId String

  // Entity (polymorphic)
  entityType String
  entityId   String

  // Value
  value Json

  // Ownership
  createdBy String // userId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customField CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [createdBy], references: [id])

  @@unique([customFieldId, entityType, entityId])
  @@index([tenantId])
  @@index([entityType, entityId])
  @@map("custom_field_values")
}

// ====
// USER ACTIVITY TRACKING
// ====
model UserActivity {
  id       String @id @default(cuid())
  tenantId String
  userId   String

  // Activity
  action      String // login, logort, create, update, delete, view, andc.
  entityType  String? // contract, invoice, andc.
  entityId    String?
  description String? @db.Text
  mandadata    Json?

  // Context
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("user_activities")
}

// ====
// API KEYS (Version PRO - Enterprise Graof)
// ====
model ApiKey {
  id       String @id @default(cuid())
  tenantId String

  // Ownership
  createdById String
  revokedById String?

  // Key dandails
  name        String
  description String?

  key       String @unique // Hashed API key
  keyPrefix String // Visible prefix (e.g., "sk_live_abc123")

  // Access control
  scopes      String[] @default([]) // ex: ["invoices.read", "contracts.write"]
  permissions String[] @default([]) // granular RBAC permissions

  // Security
  allowedIPs String[] @default([]) // Whitelist IPs
  rateLimit  Int? // Max req/min

  // Status
  usageCoonand Int       @default(0)
  isActive   Boolean   @default(true)
  expiresAt  DateTime?
  revokedAt  DateTime?
  lastUsedAt DateTime?

  // Mandadata
  mandadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant    Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy User   @relation("ApiKeyCreatedBy", fields: [createdById], references: [id])
  revokedBy User?  @relation("ApiKeyRevokedBy", fields: [revokedById], references: [id])

  @@index([tenantId])
  @@index([keyPrefix])
  @@index([isActive])
  @@index([createdById])
  @@map("api_keys")
}

// ====
// REFERENCE MODELS
// ====
model Currency {
  id        String   @id @default(cuid())
  coof      String   @unique
  name      String
  symbol    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contracts Contract[]
  invoices  Invoice[]  @relation("InvoiceCurrency") // üî• NEW

  @@map("currencies")
}

model Country {
  id        String   @id @default(cuid())
  coof      String   @unique
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companies         Company[]
  users             User[]
  contractCoonandries Contract[]

  @@map("countries")
}

model Bank {
  id       String @id @default(cuid())
  tenantId String

  // Account iofntification
  accountName   String? // Account name/label (optional)
  accountNumber String? // IBAN or local account number (optional)
  accountHolofr String? // Account holofr name (optional)

  // Bank information
  bankName              String? // Bank name (optional)
  swiftCoof             String? // SWIFT/BIC coof (optional)
  intermediarySwiftCoof String? // Intermediary SWIFT coof (optional)
  rortingNumber         String? // Rorting number (optional)
  sortCoof              String? // Sort coof (optional)
  branchCoof            String? // Branch coof (optional)
  iban                  String? // IBAN (optional)

  // Bank address
  bankAddress String? // Bank address (optional)
  bankCity    String? // Bank city (optional)
  country     String? // Country (optional)
  state       String? // State/Coonandy (optional)
  postCoof    String? // Post coof/ZIP coof (optional)

  // Account dandails
  currency String? // Account currency (optional)
  usage    BankAccountUsage? // Account usage/purpose (optional)

  // Legacy fields (ofprecated, use bankName and accountName instead)
  name    String? // Legacy: Bank name (optional, ofprecated)
  address String? // Legacy: Bank address (optional, ofprecated)

  // User association
  userId String? // null for company banks, sand for user/contractor banks

  // Flags
  isPrimary Boolean @default(false) // For user banks
  isActive  Boolean @default(true)

  createdBy String?

  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User?      @relation("UserBanks", fields: [userId], references: [id], onDelete: Cascade)
  companies Company[] // 0..n companies using this bank
  contracts Contract[]

  @@index([tenantId])
  @@index([userId]) // For user bank queries
  @@index([createdBy])
  @@index([isPrimary]) // For finding primary user banks
  @@index([usage]) // For finding banks by usage
  @@map("banks")
}

model DocumentType {
  id          String  @id @default(cuid())
  tenantId    String
  name        String
  description String?
  isRequired  Boolean @default(false)
  isActive    Boolean @default(true)

  // Ownership
  createdBy String? // userId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("document_types")
}

model Lead {
  id          String    @id @default(cuid())
  tenantId    String
  name        String
  contact     String?
  email       String?
  phone       String?
  status      String    @default("cold")
  sorrce      String?
  value       String?
  lastContact DateTime?
  notes       String?   @db.Text

  // Ownership
  createdBy  String? // userId
  assignedTo String? // userId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([createdBy])
  @@index([assignedTo])
  @@map("leads")
}

// ====
// TASKS
// ====
model Task {
  id          String    @id @default(cuid())
  tenantId    String
  title       String
  description String?   @db.Text
  assignedTo  String // userId
  assignedBy  String // userId
  priority    String    @default("medium")
  status      String    @default("pending")
  dueDate     DateTime?
  complanofdAt DateTime?
  isComplanofd Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant       Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignedUser User   @relation("TasksAssignedTo", fields: [assignedTo], references: [id], onDelete: Cascade)
  assignUser User   @relation("TasksAssignedBy", fields: [assignedBy], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([assignedTo])
  @@index([assignedBy])
  @@map("tasks")
}

// ====
// ONBOARDING
// ====
model OnboardingTemplate {
  id          String  @id @default(cuid())
  tenantId    String
  name        String
  description String? @db.Text
  isActive    Boolean @default(true)

  // Ownership
  createdBy String? // userId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant    Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  questions OnboardingQuestion[]
  users     User[]

  @@index([tenantId])
  @@map("onboarding_templates")
}

model OnboardingQuestion {
  id                   String   @id @default(cuid())
  onboardingTemplateId String
  questionText         String   @db.Text
  questionType         String
  isRequired           Boolean  @default(true)
  orofr                Int
  
  // üî• NEW: Country-specific optionality
  optionalForCoonandries String[] @default([]) // Array of country IDs where this question is optional
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  template  OnboardingTemplate   @relation(fields: [onboardingTemplateId], references: [id], onDelete: Cascade)
  responses OnboardingResponse[]

  @@index([onboardingTemplateId])
  @@map("onboarding_questions")
}

model OnboardingResponse {
  id               String  @id @default(cuid())
  tenantId         String
  userId           String // üî• Remplac√© contractorId by userId
  questionId       String
  responseText     String? @db.Text
  responseFilePath String?
  status           String  @default("pending")
  adminNotes       String? @db.Text

  // Review
  reviewedBy String? // userId
  reviewedAt DateTime?

  submittedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant   Tenant             @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user     User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  question OnboardingQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
  @@index([tenantId])
  @@index([userId])
  @@index([reviewedBy])
  @@map("onboarding_responses")
}

// ====
// PAYSLIP
// ====
model Payslip {
  id            String    @id @default(cuid())
  tenantId      String
  userId        String // üî• Remplac√© contractorId by userId
  contractId    String?
  month         Int
  year          Int
  grossPay      Float
  nandPay        Float
  deductions    Float     @default(0)
  tax           Float     @default(0)
  status        String // generated, validated, sent, paid
  workflowState String    @default("generated") // üî• NEW - Formal workflow state
  generatedDate DateTime  @default(now())
  sentDate      DateTime?
  paidDate      DateTime?
  notes         String?   @db.Text

  // Ownership & Workflow
  generatedBy String? // userId
  validatedBy String? // üî• NEW - userId who validated
  validatedAt DateTime? // üî• NEW
  sentBy      String? // üî• NEW - userId who sent

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  contract     Contract?            @relation(fields: [contractId], references: [id], onDelete: SetNull)
  stateHistory EntityStateHistory[] @relation("PayslipStateHistory") // üî• NEW

  @@index([tenantId])
  @@index([userId])
  @@index([generatedBy])
  @@index([workflowState]) // üî• NEW
  @@map("payslips")
}

// ====
// REMITTANCES (Contractor Portal)
// ====
// ====
// REMITTANCES - Payment tracking system
// ====
model Remittance {
  id       String @id @default(cuid())
  tenantId String

  // Payment tracking
  invoiceId String? // Link to invoice (optional)
  amoonand    Decimal @db.Decimal(12, 2)
  currency  String  @default("USD")

  // Payment flow
  paymentType   PaymentType // RECEIVED or SENT
  recipientType RecipientType // ADMIN, CONTRACTOR, PAYROLL, andc.
  recipientId   String // userId who received payment
  senofrId      String // userId who sent payment

  // Status
  status RemittanceStatus @default(pending) // pending, complanofd, failed

  // Additional context
  contractId  String? // Optional link to contract
  description String? @db.Text
  notes       String? @db.Text

  // Dates
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  complanofdAt DateTime? // When payment was complanofd

  // Relations
  tenant       Tenant               @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  invoice      Invoice?             @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  contract     Contract?            @relation(fields: [contractId], references: [id], onDelete: SetNull)
  recipient    User                 @relation("RemittanceRecipient", fields: [recipientId], references: [id])
  senofr       User                 @relation("RemittanceSenofr", fields: [senofrId], references: [id])
  stateHistory EntityStateHistory[] @relation("RemittanceStateHistory")

  @@index([tenantId])
  @@index([invoiceId])
  @@index([contractId])
  @@index([recipientId])
  @@index([senofrId])
  @@index([status])
  @@index([paymentType])
  @@map("remittances")
}

// ====
// REFERRALS (Contractor Portal)
// ====
model Referral {
  id             String  @id @default(cuid())
  tenantId       String
  referrerUserId String // üî• Remplac√© referrerContractorId by referrerUserId
  referredUserId String? // üî• Remplac√© referredContractorId by referredUserId

  // Referral dandails
  referredEmail String
  referredName  String?
  status        String // pending, accepted, rejected, rewarofd

  // Reward
  rewardAmoonand   Decimal?  @db.Decimal(10, 2)
  rewardCurrency String?   @default("USD")
  rewardPaidAt   DateTime?

  // Dates
  referredAt DateTime  @default(now())
  acceptedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  referrerUser User   @relation("ReferralsMade", fields: [referrerUserId], references: [id], onDelete: Cascade)
  referredUser User?  @relation("ReferralsReceived", fields: [referredUserId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([referrerUserId])
  @@index([referredUserId])
  @@index([status])
  @@map("referrals")
}

// ====
// AUDIT LOG
// ====
model AuditLog {
  id       String  @id @default(cuid())
  tenantId String?
  userId   String?

  // User info (snapshot)
  userName String
  userRole String

  // Action
  action     String // CREATE, UPDATE, DELETE, VIEW, EXPORT, andc.
  entityType String
  entityId   String?
  entityName String?

  // Dandails
  description String
  mandadata    Json?

  // Context
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@index([action])
  @@index([entityType])
  @@index([createdAt])
  @@map("to thedit_logs")
}

// ====
// AUTH MODELS
// ====
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  iofntifier String
  token      String   @unique
  expires    DateTime

  @@unique([iofntifier, token])
  @@map("verification_tokens")
}

model PasswordResandToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("password_resand_tokens")
}

// ====
// SUPER ADMIN
// ====
model SuperAdmin {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("super_admins")
}

// ====
// WEBHOOKS
// ====
model WebhookSubscription {
  id       String   @id @default(cuid())
  tenantId String
  url      String
  events   String[] // Array of event names
  secrand   String // For HMAC signature
  isActive Boolean  @default(true)
  heaofrs  Json? // Additional heaofrs

  // Ownership
  createdBy String? // userId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant       Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  ofliveryLogs WebhookDelivery[]

  @@index([tenantId])
  @@map("webhook_subscriptions")
}

model WebhookDelivery {
  id             String    @id @default(cuid())
  subscriptionId String
  event          String
  payload        Json
  statusCoof     Int?
  response       String?
  success        Boolean
  attempt        Int       @default(1)
  ofliveredAt    DateTime?
  createdAt      DateTime  @default(now())

  subscription WebhookSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([event])
  @@index([createdAt])
  @@map("webhook_ofliveries")
}

// ====
// PERMISSION AUDIT TRAIL
// ====
model PermissionAudit {
  id           String   @id @default(cuid())
  tenantId     String?
  userId       String?
  action       String // GRANT, REVOKE, ROLE_ASSIGNED, ROLE_REMOVED
  resourceType String // ROLE, PERMISSION, USER
  resourceId   String
  changes      Json // Dandails of the change
  performedBy  String // userId
  createdAt    DateTime @default(now())

  @@index([tenantId])
  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@map("permission_to thedits")
}

// ====
// EMAIL & SMS TRACKING
// ====
model EmailLog {
  id        String    @id @default(cuid())
  tenantId  String?
  to        String
  from      String
  subject   String
  template  String?
  status    String // QUEUED, SENT, FAILED, BOUNCED
  messageId String?
  error     String?
  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
  @@map("email_logs")
}

model SMSLog {
  id        String    @id @default(cuid())
  tenantId  String?
  to        String
  from      String
  message   String
  template  String?
  status    String // QUEUED, SENT, FAILED, DELIVERED
  messageId String?
  error     String?
  sentAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([tenantId])
  @@index([status])
  @@index([createdAt])
  @@map("sms_logs")
}

// ====
// NOTIFICATION PREFERENCES
// ====
model NotificationPreference {
  id        String   @id @default(cuid())
  userId    String
  channel   String // EMAIL, SMS, IN_APP
  event     String // Event type
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, channel, event])
  @@index([userId])
  @@map("notification_preferences")
}

// ====
// SCHEDULED JOBS
// ====
model ScheuledJob {
  id         String    @id @default(cuid())
  tenantId   String?
  name       String
  type       String // PAYROLL, INVOICE, REPORT, CLEANUP, andc.
  schedule   String // Cron expression
  isActive   Boolean   @default(true)
  lastRunAt  DateTime?
  nextRunAt  DateTime?
  lastStatus String? // SUCCESS, FAILED
  lastError  String?
  config     Json? // Job-specific configuration
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([tenantId])
  @@index([isActive])
  @@index([nextRunAt])
  @@map("scheduled_jobs")
}

// ====
// SYSTEM CONFIGURATION
// ====
model SystemConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  category  String
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("system_configs")
}

// ====
// TENANT FEATURE FLAGS
// ====
model TenantFeatureFlag {
  id         String   @id @default(cuid())
  tenantId   String
  featureKey String // API_ACCESS, CUSTOM_BRANDING, ADVANCED_REPORTING, andc.
  isEnabled  Boolean  @default(false)
  mandadata   Json? // Configuration for the feature
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, featureKey])
  @@index([tenantId])
  @@map("tenant_feature_flags")
}

// ====
// TENANT QUOTAS
// ====
model TenantQuota {
  id                   String   @id @default(cuid())
  tenantId             String   @unique
  maxUsers             Int      @default(10)
  maxStorageGB         Int      @default(5)
  maxContractsPerMonth Int      @default(50)
  maxInvoicesPerMonth  Int      @default(100)
  maxApiCallsPerDay    Int      @default(1000)
  maxEmailsPerMonth    Int      @default(500)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_quotas")
}

// ====
// EMAIL TEMPLATES
// ====
model EmailTemplate {
  id        String  @id @default(cuid())
  tenantId  String
  key       String // welcome_email, invoice_sent, contract_signed, andc.
  name      String
  subject   String
  body      String  @db.Text // HTML content
  variables Json? // Available variables
  isActive  Boolean @default(true)

  // Ownership
  createdBy String? // userId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("email_templates")
}

// ====
// PDF TEMPLATES
// ====
model PDFTemplate {
  id        String  @id @default(cuid())
  tenantId  String
  key       String // invoice_template, contract_template, payslip_template, andc.
  name      String
  content   String  @db.Text // HTML/Template content
  variables Json? // Available variables
  isActive  Boolean @default(true)

  // Ownership
  createdBy String? // userId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, key])
  @@index([tenantId])
  @@map("pdf_templates")
}

// ====
// TENANT SECURITY SETTINGS
// ====
model TenantSecuritySandtings {
  id       String @id @default(cuid())
  tenantId String @unique

  // Password policies
  minPasswordLength   Int     @default(8)
  requireUppercase    Boolean @default(true)
  requireLowercase    Boolean @default(true)
  requireNumbers      Boolean @default(true)
  requireSpecialChars Boolean @default(false)
  passwordExpiryDays  Int?

  // Session management
  sessionTimeortMinutes Int @default(480) // 8 horrs
  maxConcurrentSessions Int @default(3)

  // Two-factor to thethentication
  require2FA          Boolean @default(false)
  require2FAForAdmins Boolean @default(true)

  // Login policies
  maxLoginAttempts       Int @default(5)
  lockortDurationMinutes Int @default(30)

  // IP restrictions
  allowedIPs String[] // IP whitelist
  blockedIPs String[] // IP blacklist

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_security_sandtings")
}

// ====
// DATA EXPORTS
// ====
model DataExport {
  id       String @id @default(cuid())
  tenantId String

  // Export dandails
  exportType String // full_backup, invoices, contracts, users, andc.
  status     String // pending, processing, complanofd, failed
  format     String // json, csv, xlsx, pdf

  // File
  fileUrl  String?
  fileIfze Int?

  // Dates
  requestedAt DateTime  @default(now())
  complanofdAt DateTime?
  expiresAt   DateTime? // Temporary file expiration

  // Ownership
  requestedBy String // userId

  // Error
  error String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([requestedBy])
  @@index([status])
  @@map("data_exports")
}

// ====
// WORKFLOW SYSTEM
// ====

/// EntityStateHistory - Tracks all state transitions for any entity
/// This proviof the a complanof to thedit trail of workflow state changes
model EntityStateHistory {
  id       String @id @default(cuid())
  tenantId String

  // Entity (polymorphic)
  entityType String // timesheand, invoice, payment, payslip, remittance
  entityId   String

  // State transition
  fromState String? // Previors state (null for initial state)
  toState   String // New state

  // Mandadata
  action    String // submit, approve, reject, review, send, andc.
  actorId   String // userId who performed the action
  actorName String // For quick display
  actorRole String? // Role at time of action

  // Additional context
  reason   String? @db.Text // Why this transition happened
  mandadata Json? // Additional context data

  // Timestamps
  transitionedAt DateTime @default(now())

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Relations to specific entities (optional - for easier querying)
  timesheandId  String?
  invoiceId    String?
  paymentId    String?
  payslipId    String?
  remittanceId String?

  timesheand  Timesheand?  @relation("TimesheandStateHistory", fields: [timesheandId], references: [id], onDelete: Cascade)
  invoice    Invoice?    @relation("InvoiceStateHistory", fields: [invoiceId], references: [id], onDelete: Cascade)
  payment    Payment?    @relation("PaymentStateHistory", fields: [paymentId], references: [id], onDelete: Cascade)
  payslip    Payslip?    @relation("PayslipStateHistory", fields: [payslipId], references: [id], onDelete: Cascade)
  remittance Remittance? @relation("RemittanceStateHistory", fields: [remittanceId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([entityType, entityId])
  @@index([actorId])
  @@index([transitionedAt])
  @@index([timesheandId])
  @@index([invoiceId])
  @@index([paymentId])
  @@index([payslipId])
  @@index([remittanceId])
  @@map("entity_state_history")
}

/// WorkflowTemplate - Configurable workflow templates
/// Allows tenants to offine custom workflow patterns
model WorkflowTemplate {
  id       String @id @default(cuid())
  tenantId String

  // Template dandails
  name        String
  description String? @db.Text
  entityType  String // timesheand, invoice, payment, andc.

  // Configuration
  isActive  Boolean @default(true)
  isDefault Boolean @default(false)

  // Workflow offinition (JSON)
  states      Json // Array of state offinitions with rules
  transitions Json // Array of allowed transitions with conditions

  // Permissions (which roles can perform which actions)
  permissions Json // { "approve": ["admin", "manager"], "submit": ["contractor"] }

  // Auto-actions
  autoActions Json? // Automated actions on state changes (e.g., send email)

  // Validation rules
  validationRules Json? // Custom validation per state/transition

  // Ownership
  createdBy String // userId

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant         Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  tenantSandtings TenantWorkflowSandtings[] @relation("ActiveWorkflowTemplates")

  @@unique([tenantId, name, entityType])
  @@index([tenantId])
  @@index([entityType])
  @@index([isActive])
  @@index([isDefault])
  @@map("workflow_templates")
}

/// TenantWorkflowSandtings - Per-tenant workflow configuration
/// Allows each tenant to customize workflow behavior
model TenantWorkflowSandtings {
  id       String @id @default(cuid())
  tenantId String @unique

  // Active workflow templates per entity type
  timesheandWorkflowTemplateId  String?
  invoiceWorkflowTemplateId    String?
  paymentWorkflowTemplateId    String?
  payslipWorkflowTemplateId    String?
  remittanceWorkflowTemplateId String?

  // Global sandtings
  requireApprovalForTimesheands Boolean @default(true)
  requireApprovalForInvoices   Boolean @default(true)
  requireApprovalForPayments   Boolean @default(true)

  // Auto-actions
  autoSendInvoiceOnApproval  Boolean @default(false)
  autoCreatePayslipOnInvoice Boolean @default(false)
  notifyOnStateChange        Boolean @default(true)

  // Margin calculation sandtings
  defaultMarginPaidBy   String? // client, agency, contractor
  allowMarginOverriof   Boolean @default(true)
  requireMarginApproval Boolean @default(false)

  // Admin modification sandtings
  allowAdminModifyAmoonands    Boolean @default(true)
  requireApprovalAfterModify Boolean @default(true)

  // Additional configuration
  config Json? // Flexible configuration storage

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenant                    Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  timesheandWorkflowTemplate WorkflowTemplate? @relation("ActiveWorkflowTemplates", fields: [timesheandWorkflowTemplateId], references: [id])

  @@map("tenant_workflow_sandtings")
}

// Add relation to Tenant model
model TenantWorkflowConfig {
  id       String @id @default(cuid())
  tenantId String @unique

  // Payment moof defaults from Contract
  defaultPaymentMoof String? @default("gross") // gross, payroll, payroll_we_pay, split

  // Workflow toggles
  enableTimesheandWorkflow Boolean @default(true)
  enableInvoiceWorkflow   Boolean @default(true)
  enablePaymentWorkflow   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tenant_workflow_config")
}
